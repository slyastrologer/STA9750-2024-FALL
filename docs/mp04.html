<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Hassan Adolphus">

<title>mp04 – STA 9750 2024 Submission Material</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">STA 9750 2024 Submission Material</span>
    </a>
  </div>
        <div class="quarto-navbar-tools tools-end">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">mp04</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Hassan Adolphus </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="mini-project-4" class="level1">
<h1>MINI PROJECT 4</h1>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">INTRODUCTION</h2>
<p>In this project, we will simulate the role of a financial advisor in order to explore the benefits and drawbacks of the two retirement plans offered to CUNY employees. When hired, CUNY employees have 30 days to select one of two retirement plans: either a plan offered by the Teachers’ Retirement System of New York City (TRSNYC), or a plan offered by the Teachers’ Insurance and Annuity Association of America (TIAA). This decision is permanent and cannot be altered later. In order to determine which plan outperforms the other, we will use historical financial data and a “bootstrap inference method” in order to draw our conclusion.</p>
</section>
<section id="task-1-register-for-alpha-vantage-api-key" class="level2">
<h2 class="anchored" data-anchor-id="task-1-register-for-alpha-vantage-api-key">TASK 1: Register for Alpha Vantage API Key</h2>
<p>We will begin our work by importing the necessary libraries:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Attaching package: 'dplyr'</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="do">## The following objects are masked from 'package:stats':</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="do">##     filter, lag</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="do">## The following objects are masked from 'package:base':</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="do">##     intersect, setdiff, setequal, union</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(httr)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="do">## ── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="do">## ✔ forcats   1.0.0     ✔ purrr     1.0.2</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="do">## ✔ ggplot2   3.5.1     ✔ tibble    3.2.1</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="do">## ✔ lubridate 1.9.3</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="do">## ── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="do">## ✖ dplyr::filter() masks stats::filter()</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="do">## ✖ dplyr::lag()    masks stats::lag()</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="do">## ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="do">## Linking to GEOS 3.11.0, GDAL 3.5.3, PROJ 9.1.0; sf_use_s2() is TRUE</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Once we have imported our libraries, we will head to the AlphaVantage website to create an AlphaVantage API Key to obtain the U.S stock market and International stock market data necessary for our analysis.</p>
</section>
<section id="task-2-register-for-fred-api-key" class="level2">
<h2 class="anchored" data-anchor-id="task-2-register-for-fred-api-key">TASK 2: Register for FRED API Key</h2>
<p>Once we have imported our libraries and secured our AlphaVantage API Key, we will head to the St.&nbsp;Louis Fed (or FRED) website to create a FRED API key to obtain the wage growth, inflation, and short debt data necessary for our analysis.</p>
</section>
<section id="task-3-data-acquisition" class="level2">
<h2 class="anchored" data-anchor-id="task-3-data-acquisition">TASK 3: Data Acquisition</h2>
<p>Now that we have our API keys for our data access, we will begin automating our data import. For our analysis, we will need data on five main metrics: wage growth, inflation, U.S stock performance, International stock performance, and short term debt.</p>
<p>To start, we will import data from FRED on quarterly wage growth in New York State for the last decade. We will then save the imported dataframe as a CSV file locally in case we need to reference the local data later.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="do">## LOAD REQUIRED LIBRARIES ##</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(httr)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(jsonlite)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="do">## Attaching package: 'jsonlite'</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="do">## The following object is masked from 'package:purrr':</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="do">##     flatten</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="do">## WAGE GROWTH ##</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the FRED API endpoint and the FRED API key</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>api_key <span class="ot">&lt;-</span> <span class="st">"ffc31969aa3d7177ca28636e5b65c963"</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>base_url <span class="ot">&lt;-</span> <span class="st">"https://api.stlouisfed.org/fred/"</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the FRED series ID for the data you want to download</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>series_id <span class="ot">&lt;-</span> <span class="st">"NYWTOT"</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the URL to get the data for a specific series</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>url <span class="ot">&lt;-</span> <span class="fu">paste0</span>(base_url, <span class="st">"series/observations"</span>)</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the query parameters</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">series_id =</span> series_id,        <span class="co"># The series ID</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">api_key =</span> api_key,            <span class="co"># The API key</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">file_type =</span> <span class="st">"json"</span>,           <span class="co"># Specify the file type as JSON</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">frequency =</span> <span class="st">"q"</span>,              <span class="co"># Data frequency</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">units =</span> <span class="st">"lin"</span>,                <span class="co"># Linear units</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">start_date =</span> <span class="st">"2014-04-01"</span>,    <span class="co"># Start date</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">end_date =</span> <span class="st">"2024-04-01"</span>       <span class="co"># End date</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Make the GET request to the FRED API</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>response <span class="ot">&lt;-</span> <span class="fu">GET</span>(url, <span class="at">query =</span> params)</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if the request was successful (status code 200 means OK)</span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">status_code</span>(response) <span class="sc">==</span> <span class="dv">200</span>) {</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Parse the JSON response</span></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">fromJSON</span>(<span class="fu">content</span>(response, <span class="st">"text"</span>))</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract the observations</span></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>  observations <span class="ot">&lt;-</span> data<span class="sc">$</span>observations</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert to a data frame</span></span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>  data_wagegrowth <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(observations)</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Display the first few rows of the data</span></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(data_wagegrowth)</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Save the data to a CSV file</span></span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write.csv</span>(data_wagegrowth, <span class="st">"fred_data_wagegrowth.csv"</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If the request succeeds, print a download message</span></span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Data has been successfully downloaded and saved as 'fred_data_wagegrowth.csv'.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If the request fails, print an error message</span></span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Failed to retrieve data. Status code:"</span>, <span class="fu">status_code</span>(response), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a><span class="do">## Data has been successfully downloaded and saved as 'fred_data_wagegrowth.csv'.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Next, we will import data from FRED on quarterly inflation in the United States for the last decade. We will do this to make aligning and combining our wage growth and inflation data easier later on in our project. We will then save the imported dataframe as a CSV file locally in case we need to reference the local data later.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="do">## INFLATION ##</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the FRED API endpoint and the FRED API key</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>api_key <span class="ot">&lt;-</span> <span class="st">"ffc31969aa3d7177ca28636e5b65c963"</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>base_url <span class="ot">&lt;-</span> <span class="st">"https://api.stlouisfed.org/fred/"</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the FRED series ID for the data you want to download</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>series_id <span class="ot">&lt;-</span> <span class="st">"CPALTT01USQ657N"</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the URL to get the data for a specific series</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>url <span class="ot">&lt;-</span> <span class="fu">paste0</span>(base_url, <span class="st">"series/observations"</span>)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the query parameters</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">series_id =</span> series_id,        <span class="co"># The series ID</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">api_key =</span> api_key,            <span class="co"># The API key</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">file_type =</span> <span class="st">"json"</span>,           <span class="co"># Specify the file type as JSON</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">frequency =</span> <span class="st">"q"</span>,              <span class="co"># Data frequency</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">units =</span> <span class="st">"lin"</span>,                <span class="co"># Linear units</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">start_date =</span> <span class="st">"2014-04-01"</span>,    <span class="co"># Start date</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">end_date =</span> <span class="st">"2024-04-01"</span>       <span class="co"># End date</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Make the GET request to the FRED API</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>response <span class="ot">&lt;-</span> <span class="fu">GET</span>(url, <span class="at">query =</span> params)</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if the request was successful (status code 200 means OK)</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">status_code</span>(response) <span class="sc">==</span> <span class="dv">200</span>) {</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Parse the JSON response</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">fromJSON</span>(<span class="fu">content</span>(response, <span class="st">"text"</span>))</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract the observations</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>  observations <span class="ot">&lt;-</span> data<span class="sc">$</span>observations</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert to a data frame</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>  data_inflation <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(observations)</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Display the first few rows of the data</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(data_inflation)</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Save the data to a CSV file</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write.csv</span>(data_inflation, <span class="st">"fred_data_inflation.csv"</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If the request succeeds, print a download message</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Data has been successfully downloaded and saved as 'fred_data_inflation.csv'.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If the request fails, print an error message</span></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Failed to retrieve data. Status code:"</span>, <span class="fu">status_code</span>(response), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a><span class="do">## Data has been successfully downloaded and saved as 'fred_data_inflation.csv'.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Next, we will import data from AlphaVantage on a monthly U.S stock index to measure U.S stock performance. We will use the S&amp;P500 stock index for our analysis. In AlphaVantage, the symbol for the S&amp;P500 is not the standard “^GSPC”, but rather “SPY”.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="do">## US EQUITY MARKET TOTAL RETURNS ##</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the Alpha Vantage API key and base URL</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>api_key <span class="ot">&lt;-</span> <span class="st">"13OR5QPKL3DGT9U6"</span>  <span class="co"># Alpha Vantage API key</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>symbol <span class="ot">&lt;-</span> <span class="st">"SPY"</span>  <span class="co"># S&amp;P 500 ETF</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>function_type <span class="ot">&lt;-</span> <span class="st">"TIME_SERIES_MONTHLY"</span>  <span class="co"># Monthly historical data</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>output_size <span class="ot">&lt;-</span> <span class="st">"full"</span>  <span class="co"># Full time series</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Construct the API request URL</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>url <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"https://www.alphavantage.co/query?function="</span>, function_type,</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>              <span class="st">"&amp;symbol="</span>, symbol, </span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>              <span class="st">"&amp;apikey="</span>, api_key, </span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>              <span class="st">"&amp;outputsize="</span>, output_size)</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Make the API request</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>response <span class="ot">&lt;-</span> <span class="fu">GET</span>(url)</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if the request was successful</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">status_code</span>(response) <span class="sc">==</span> <span class="dv">200</span>) {</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Parse the JSON content of the response</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">content</span>(response, <span class="st">"parsed"</span>, <span class="at">type =</span> <span class="st">"application/json"</span>)</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract the historical time series data (if present)</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (function_type <span class="sc">==</span> <span class="st">"TIME_SERIES_MONTHLY"</span>) {</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    time_series <span class="ot">&lt;-</span> data[[<span class="st">"Monthly Time Series"</span>]]</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert the time series into a data frame</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(time_series)) {</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Convert the list to a data frame where each date is a row</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>      data_sap500 <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(time_series, unlist)))</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Set column names for open, high, low, close, volume</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>      <span class="fu">colnames</span>(data_sap500) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"open"</span>, <span class="st">"high"</span>, <span class="st">"low"</span>, <span class="st">"close"</span>, <span class="st">"volume"</span>)</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Convert the row names to a date column</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>      data_sap500<span class="sc">$</span>date <span class="ot">&lt;-</span> <span class="fu">rownames</span>(data_sap500)</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rownames</span>(data_sap500) <span class="ot">&lt;-</span> <span class="cn">NULL</span>  <span class="co"># Remove row names</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Ensure the date column is in Date format (using the first of each month)</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>      data_sap500<span class="sc">$</span>date <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(<span class="fu">paste0</span>(data_sap500<span class="sc">$</span>date, <span class="st">"-01"</span>))</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Print out the first few rows of the data frame</span></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(<span class="fu">head</span>(data_sap500))</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(<span class="st">"Error: No time series data found."</span>)</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If the request was unsuccessful, print the error message</span></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"Request failed with status:"</span>, <span class="fu">status_code</span>(response)))</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">content</span>(response, <span class="st">"text"</span>))</span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a><span class="do">##       open     high      low    close     volume       date</span></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a><span class="do">## 1 602.9700 607.9100 602.3410 607.6600   98902515 2024-12-04</span></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a><span class="do">## 2 571.3200 603.3500 567.8900 602.5500  901761281 2024-11-29</span></span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a><span class="do">## 3 573.4000 586.1200 565.2700 568.6400  976134821 2024-10-31</span></span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a><span class="do">## 4 560.4700 574.7100 539.4400 573.7600 1044167074 2024-09-30</span></span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a><span class="do">## 5 552.5700 564.2000 510.2700 563.6800 1244598926 2024-08-30</span></span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a><span class="do">## 6 545.6300 565.1600 537.4500 550.8100 1038489736 2024-07-31</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Next, we will import data from AlphaVantage on a monthly International stock index to measure International stock performance. We will use the MSCI stock index for our analysis. In AlphaVantage, the symbol for the MSCI is not the standard “MSCI”, but rather “EFA”.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="do">## INTL EQUITY MARKET TOTAL RETURNS ##</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the Alpha Vantage API key and base URL</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>api_key <span class="ot">&lt;-</span> <span class="st">"13OR5QPKL3DGT9U6"</span>  <span class="co"># Alpha Vantage API key</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>symbol <span class="ot">&lt;-</span> <span class="st">"EFA"</span>  <span class="co"># MSCI Developed Markets ETF</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>function_type <span class="ot">&lt;-</span> <span class="st">"TIME_SERIES_MONTHLY"</span>  <span class="co"># Monthly historical data</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>output_size <span class="ot">&lt;-</span> <span class="st">"full"</span>  <span class="co"># Full time series</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Construct the API request URL</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>url <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"https://www.alphavantage.co/query?function="</span>, function_type,</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>              <span class="st">"&amp;symbol="</span>, symbol, </span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>              <span class="st">"&amp;apikey="</span>, api_key, </span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>              <span class="st">"&amp;outputsize="</span>, output_size)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Make the API request</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>response <span class="ot">&lt;-</span> <span class="fu">GET</span>(url)</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if the request was successful</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">status_code</span>(response) <span class="sc">==</span> <span class="dv">200</span>) {</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Parse the JSON content of the response</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">content</span>(response, <span class="st">"parsed"</span>, <span class="at">type =</span> <span class="st">"application/json"</span>)</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract the historical time series data (if present)</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (function_type <span class="sc">==</span> <span class="st">"TIME_SERIES_MONTHLY"</span>) {</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    time_series <span class="ot">&lt;-</span> data[[<span class="st">"Monthly Time Series"</span>]]</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert the time series into a data frame</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(time_series)) {</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Convert the list to a data frame where each date is a row</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>      data_msci <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(time_series, unlist)))</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Set column names for open, high, low, close, volume</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>      <span class="fu">colnames</span>(data_msci) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"open"</span>, <span class="st">"high"</span>, <span class="st">"low"</span>, <span class="st">"close"</span>, <span class="st">"volume"</span>)</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Convert the row names to a date column</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>      data_msci<span class="sc">$</span>date <span class="ot">&lt;-</span> <span class="fu">rownames</span>(data_msci)</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rownames</span>(data_msci) <span class="ot">&lt;-</span> <span class="cn">NULL</span>  <span class="co"># Remove row names</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Ensure the date column is in Date format (using the first of each month)</span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>      data_msci<span class="sc">$</span>date <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(<span class="fu">paste0</span>(data_msci<span class="sc">$</span>date, <span class="st">"-01"</span>))</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Print out the first few rows of the data frame</span></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(<span class="fu">head</span>(data_msci))</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(<span class="st">"Error: No time series data found."</span>)</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If the request was unsuccessful, print the error message</span></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"Request failed with status:"</span>, <span class="fu">status_code</span>(response)))</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">content</span>(response, <span class="st">"text"</span>))</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a><span class="do">##      open    high     low   close    volume       date</span></span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a><span class="do">## 1 79.0800 79.8750 78.5700 79.7000  39349751 2024-12-04</span></span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a><span class="do">## 2 79.6500 80.3400 76.7017 78.9700 249509400 2024-11-29</span></span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a><span class="do">## 3 83.6600 83.6900 78.4700 79.2200 203049290 2024-10-31</span></span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a><span class="do">## 4 82.5600 84.5563 79.3750 83.6300 202580392 2024-09-30</span></span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a><span class="do">## 5 79.3400 83.2842 73.9100 82.9800 281380677 2024-08-30</span></span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a><span class="do">## 6 78.7600 81.8700 77.9800 80.3600 252837489 2024-07-31</span></span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a><span class="do">## BOND MARKET TOTAL RETURNS ##</span></span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the Alpha Vantage API key and base URL</span></span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>api_key <span class="ot">&lt;-</span> <span class="st">"13OR5QPKL3DGT9U6"</span>  <span class="co"># Alpha Vantage API key</span></span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a>symbol <span class="ot">&lt;-</span> <span class="st">"AGG"</span>  <span class="co"># Bond Markets ETF</span></span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a>function_type <span class="ot">&lt;-</span> <span class="st">"TIME_SERIES_MONTHLY"</span>  <span class="co"># Monthly historical data</span></span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a>output_size <span class="ot">&lt;-</span> <span class="st">"full"</span>  <span class="co"># Full time series</span></span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a><span class="co"># Construct the API request URL</span></span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>url <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"https://www.alphavantage.co/query?function="</span>, function_type,</span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a>              <span class="st">"&amp;symbol="</span>, symbol, </span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a>              <span class="st">"&amp;apikey="</span>, api_key, </span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a>              <span class="st">"&amp;outputsize="</span>, output_size)</span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a><span class="co"># Make the API request</span></span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a>response <span class="ot">&lt;-</span> <span class="fu">GET</span>(url)</span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if the request was successful</span></span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">status_code</span>(response) <span class="sc">==</span> <span class="dv">200</span>) {</span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Parse the JSON content of the response</span></span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">content</span>(response, <span class="st">"parsed"</span>, <span class="at">type =</span> <span class="st">"application/json"</span>)</span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract the historical time series data (if present)</span></span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (function_type <span class="sc">==</span> <span class="st">"TIME_SERIES_MONTHLY"</span>) {</span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a>    time_series <span class="ot">&lt;-</span> data[[<span class="st">"Monthly Time Series"</span>]]</span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert the time series into a data frame</span></span>
<span id="cb5-80"><a href="#cb5-80" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(time_series)) {</span>
<span id="cb5-81"><a href="#cb5-81" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Convert the list to a data frame where each date is a row</span></span>
<span id="cb5-82"><a href="#cb5-82" aria-hidden="true" tabindex="-1"></a>      data_bondreturns <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(time_series, unlist)))</span>
<span id="cb5-83"><a href="#cb5-83" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Set column names for open, high, low, close, volume</span></span>
<span id="cb5-84"><a href="#cb5-84" aria-hidden="true" tabindex="-1"></a>      <span class="fu">colnames</span>(data_bondreturns) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"open"</span>, <span class="st">"high"</span>, <span class="st">"low"</span>, <span class="st">"close"</span>, <span class="st">"volume"</span>)</span>
<span id="cb5-85"><a href="#cb5-85" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Convert the row names to a date column</span></span>
<span id="cb5-86"><a href="#cb5-86" aria-hidden="true" tabindex="-1"></a>      data_bondreturns<span class="sc">$</span>date <span class="ot">&lt;-</span> <span class="fu">rownames</span>(data_bondreturns)</span>
<span id="cb5-87"><a href="#cb5-87" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rownames</span>(data_bondreturns) <span class="ot">&lt;-</span> <span class="cn">NULL</span>  <span class="co"># Remove row names</span></span>
<span id="cb5-88"><a href="#cb5-88" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Ensure the date column is in Date format (using the first of each month)</span></span>
<span id="cb5-89"><a href="#cb5-89" aria-hidden="true" tabindex="-1"></a>      data_bondreturns<span class="sc">$</span>date <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(<span class="fu">paste0</span>(data_bondreturns<span class="sc">$</span>date, <span class="st">"-01"</span>))</span>
<span id="cb5-90"><a href="#cb5-90" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Print out the first few rows of the data frame</span></span>
<span id="cb5-91"><a href="#cb5-91" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(<span class="fu">head</span>(data_bondreturns))</span>
<span id="cb5-92"><a href="#cb5-92" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb5-93"><a href="#cb5-93" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(<span class="st">"Error: No time series data found."</span>)</span>
<span id="cb5-94"><a href="#cb5-94" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-95"><a href="#cb5-95" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-96"><a href="#cb5-96" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb5-97"><a href="#cb5-97" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If the request was unsuccessful, print the error message</span></span>
<span id="cb5-98"><a href="#cb5-98" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"Request failed with status:"</span>, <span class="fu">status_code</span>(response)))</span>
<span id="cb5-99"><a href="#cb5-99" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">content</span>(response, <span class="st">"text"</span>))</span>
<span id="cb5-100"><a href="#cb5-100" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-101"><a href="#cb5-101" aria-hidden="true" tabindex="-1"></a><span class="do">##       open     high      low    close    volume       date</span></span>
<span id="cb5-102"><a href="#cb5-102" aria-hidden="true" tabindex="-1"></a><span class="do">## 1  99.3900  99.6000  98.4840  99.0300  32629499 2024-12-04</span></span>
<span id="cb5-103"><a href="#cb5-103" aria-hidden="true" tabindex="-1"></a><span class="do">## 2  98.2900  99.2200  97.2600  99.2000 178517717 2024-11-29</span></span>
<span id="cb5-104"><a href="#cb5-104" aria-hidden="true" tabindex="-1"></a><span class="do">## 3 101.2700 101.4450  98.0871  98.4200 188425667 2024-10-31</span></span>
<span id="cb5-105"><a href="#cb5-105" aria-hidden="true" tabindex="-1"></a><span class="do">## 4 100.3200 102.0400 100.2300 101.2700 150983493 2024-09-30</span></span>
<span id="cb5-106"><a href="#cb5-106" aria-hidden="true" tabindex="-1"></a><span class="do">## 5  99.0100 100.9200  99.0050 100.2500 162160378 2024-08-30</span></span>
<span id="cb5-107"><a href="#cb5-107" aria-hidden="true" tabindex="-1"></a><span class="do">## 6  96.4300  99.1200  96.2200  99.1100 156332598 2024-07-31</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Finally, we will import data from FRED on quarterly short term debt returns in the United States for the last decade. We will do this to make aligning and combining our wage growth, inflation, and short term debt data easier later on in our project. We will then save the imported dataframe as a CSV file locally in case we need to reference the local data later.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="do">## SHORT-TERM DEBT RETURNS ##</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the FRED API endpoint and the FRED API key</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>api_key <span class="ot">&lt;-</span> <span class="st">"ffc31969aa3d7177ca28636e5b65c963"</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>base_url <span class="ot">&lt;-</span> <span class="st">"https://api.stlouisfed.org/fred/"</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the FRED series ID for the data you want to download</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>series_id <span class="ot">&lt;-</span> <span class="st">"QFRD304INFUSNO"</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the URL to get the data for a specific series</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>url <span class="ot">&lt;-</span> <span class="fu">paste0</span>(base_url, <span class="st">"series/observations"</span>)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the query parameters</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">series_id =</span> series_id,        <span class="co"># The series ID</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">api_key =</span> api_key,            <span class="co"># The API key</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">file_type =</span> <span class="st">"json"</span>,           <span class="co"># Specify the file type as JSON</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">frequency =</span> <span class="st">"q"</span>,              <span class="co"># Data frequency</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">units =</span> <span class="st">"lin"</span>,                <span class="co"># Linear units</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">start_date =</span> <span class="st">"2014-04-01"</span>,    <span class="co"># Start date</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">end_date =</span> <span class="st">"2024-04-01"</span>       <span class="co"># End date</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Make the GET request to the FRED API</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>response <span class="ot">&lt;-</span> <span class="fu">GET</span>(url, <span class="at">query =</span> params)</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if the request was successful (status code 200 means OK)</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">status_code</span>(response) <span class="sc">==</span> <span class="dv">200</span>) {</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Parse the JSON response</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">fromJSON</span>(<span class="fu">content</span>(response, <span class="st">"text"</span>))</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract the observations</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>  observations <span class="ot">&lt;-</span> data<span class="sc">$</span>observations</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert to a data frame</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>  data_shortdebts <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(observations)</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Display the first few rows of the data</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(data_shortdebts)</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Save the data to a CSV file</span></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write.csv</span>(data_shortdebts, <span class="st">"fred_data_shortdebts.csv"</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If the request succeeds, print a download message</span></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Data has been successfully downloaded and saved as 'fred_data_shortdebts.csv'.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If the request fails, print an error message</span></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Failed to retrieve data. Status code:"</span>, <span class="fu">status_code</span>(response), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a><span class="do">## Data has been successfully downloaded and saved as 'fred_data_shortdebts.csv'.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now that we have our wage growth, inflation, U.S stock performance, International stock performance, and short term debt data imported, we are ready to begin our analysis.</p>
</section>
<section id="task-4-initial-analysis" class="level2">
<h2 class="anchored" data-anchor-id="task-4-initial-analysis">TASK 4: Initial Analysis</h2>
<p>To begin our analysis, we are going to focus on visualizing trends for two hot topics in current economic news: inflation and wage growth. We must clean up the datatypes in our imported data before merging our desired datasets - in this case inflation and wage growth - into one dataset. We will do this merge by date; which you might have noticed coincides in both datasets thanks to our data import parameters from the previous task. Since the datasets are the same size, performing the merge is seamless.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Make sure that the datatypes are in correct format</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>data_inflation<span class="sc">$</span>date <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(data_inflation<span class="sc">$</span>date)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>data_inflation<span class="sc">$</span>value <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(data_inflation<span class="sc">$</span>value)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>data_wagegrowth<span class="sc">$</span>date <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(data_wagegrowth<span class="sc">$</span>date)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>data_wagegrowth<span class="sc">$</span>value <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(data_wagegrowth<span class="sc">$</span>value)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="do">## Warning: NAs introduced by coercion</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge both datasets by the 'date' column, rescale the wage growth data, omit n/a values</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>data_inflationandwages <span class="ot">&lt;-</span> <span class="fu">merge</span>(data_inflation, data_wagegrowth, <span class="at">by =</span> <span class="st">"date"</span>, <span class="at">suffixes =</span> <span class="fu">c</span>(<span class="st">"_inflation"</span>, <span class="st">"_wage_growth"</span>))</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>data_inflationandwages<span class="sc">$</span>scaled_wage_growth <span class="ot">&lt;-</span> data_inflationandwages<span class="sc">$</span>value_wage_growth <span class="sc">/</span> <span class="dv">100000000</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>data_inflationandwages <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(data_inflationandwages)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now, we will begin creating some figures and tables to visualize our data. Our first visual will be a graph visualizing the correlation between inflation and wage growth.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the data using ggplot</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(data_inflationandwages, <span class="fu">aes</span>(<span class="at">x =</span> date)) <span class="sc">+</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> value_inflation, <span class="at">color =</span> <span class="st">"Inflation"</span>), <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> scaled_wage_growth, <span class="at">color =</span> <span class="st">"Wage Growth"</span>), <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Inflation (percent)"</span>,</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">sec.axis =</span> <span class="fu">sec_axis</span>(<span class="sc">~</span> ., <span class="at">name =</span> <span class="st">"Wage Growth (hundreds of millions)"</span>)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Inflation vs Wage Growth"</span>,</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Date"</span>,</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Legend"</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Inflation"</span> <span class="ot">=</span> <span class="st">"red"</span>, <span class="st">"Wage Growth"</span> <span class="ot">=</span> <span class="st">"green"</span>)) <span class="sc">+</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>),</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"top"</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a><span class="do">## Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a><span class="do">## ℹ Please use `linewidth` instead.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="mp04_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>To continue our analysis, let’s also take a look at the other data we imported earlier; namely, U.S and International stock performance. To visualize this data, I believe a tabular form would be most suitable. Similar to before, we must clean up the datatypes in our imported data before creating our next visual. However, now that our data is in tabular form, we must make sure it is sorted and labeled correctly.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert SAP500 columns to numeric datatypes, create a year_quarter column, group "year_quarter" to calculate average open and close prices</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>data_sap500quarterlyavg <span class="ot">&lt;-</span> data_sap500 <span class="sc">|&gt;</span> </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">open =</span> <span class="fu">as.numeric</span>(open),</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">close =</span> <span class="fu">as.numeric</span>(close),</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">high =</span> <span class="fu">as.numeric</span>(high),</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">low =</span> <span class="fu">as.numeric</span>(low),</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">volume =</span> <span class="fu">as.numeric</span>(volume),</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">date =</span> <span class="fu">as.Date</span>(date),</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">year_quarter =</span> <span class="fu">paste</span>(<span class="fu">year</span>(date), <span class="st">"-Q"</span>, <span class="fu">quarter</span>(date), <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(year_quarter) <span class="sc">|&gt;</span> </span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_open =</span> <span class="fu">mean</span>(open, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_close =</span> <span class="fu">mean</span>(close, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">'drop'</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Year and Quarter</span><span class="st">`</span> <span class="ot">=</span> year_quarter,</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Average Open</span><span class="st">`</span> <span class="ot">=</span> avg_open,</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Average Close</span><span class="st">`</span> <span class="ot">=</span> avg_close</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the SAP500 results as a table</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>data_sap500quarterlyavg <span class="sc">|&gt;</span> <span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Year and Quarter</th>
<th style="text-align: right;">Average Open</th>
<th style="text-align: right;">Average Close</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">1999-Q4</td>
<td style="text-align: right;">139.31250</td>
<td style="text-align: right;">146.87500</td>
</tr>
<tr class="even">
<td style="text-align: left;">2000-Q1</td>
<td style="text-align: right;">141.87500</td>
<td style="text-align: right;">142.45833</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2000-Q2</td>
<td style="text-align: right;">146.79167</td>
<td style="text-align: right;">144.39580</td>
</tr>
<tr class="even">
<td style="text-align: left;">2000-Q3</td>
<td style="text-align: right;">147.43750</td>
<td style="text-align: right;">146.32290</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2000-Q4</td>
<td style="text-align: right;">139.90623</td>
<td style="text-align: right;">135.47393</td>
</tr>
<tr class="even">
<td style="text-align: left;">2001-Q1</td>
<td style="text-align: right;">131.05000</td>
<td style="text-align: right;">125.88667</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2001-Q2</td>
<td style="text-align: right;">122.52333</td>
<td style="text-align: right;">125.07000</td>
</tr>
<tr class="even">
<td style="text-align: left;">2001-Q3</td>
<td style="text-align: right;">119.54000</td>
<td style="text-align: right;">113.31333</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2001-Q4</td>
<td style="text-align: right;">108.05000</td>
<td style="text-align: right;">111.38333</td>
</tr>
<tr class="even">
<td style="text-align: left;">2002-Q1</td>
<td style="text-align: right;">113.30667</td>
<td style="text-align: right;">112.95000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2002-Q2</td>
<td style="text-align: right;">109.76333</td>
<td style="text-align: right;">104.68000</td>
</tr>
<tr class="even">
<td style="text-align: left;">2002-Q3</td>
<td style="text-align: right;">93.59667</td>
<td style="text-align: right;">88.24333</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2002-Q4</td>
<td style="text-align: right;">88.75000</td>
<td style="text-align: right;">90.24333</td>
</tr>
<tr class="even">
<td style="text-align: left;">2003-Q1</td>
<td style="text-align: right;">86.75000</td>
<td style="text-align: right;">85.23333</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2003-Q2</td>
<td style="text-align: right;">91.56667</td>
<td style="text-align: right;">95.49667</td>
</tr>
<tr class="even">
<td style="text-align: left;">2003-Q3</td>
<td style="text-align: right;">99.36000</td>
<td style="text-align: right;">100.26000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2003-Q4</td>
<td style="text-align: right;">104.28000</td>
<td style="text-align: right;">107.67667</td>
</tr>
<tr class="even">
<td style="text-align: left;">2004-Q1</td>
<td style="text-align: right;">113.62333</td>
<td style="text-align: right;">113.86667</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2004-Q2</td>
<td style="text-align: right;">112.30000</td>
<td style="text-align: right;">112.78333</td>
</tr>
<tr class="even">
<td style="text-align: left;">2004-Q3</td>
<td style="text-align: right;">111.79667</td>
<td style="text-align: right;">111.23667</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2004-Q4</td>
<td style="text-align: right;">114.66000</td>
<td style="text-align: right;">117.32000</td>
</tr>
<tr class="even">
<td style="text-align: left;">2005-Q1</td>
<td style="text-align: right;">120.21000</td>
<td style="text-align: right;">118.91667</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2005-Q2</td>
<td style="text-align: right;">118.07333</td>
<td style="text-align: right;">118.13667</td>
</tr>
<tr class="even">
<td style="text-align: left;">2005-Q3</td>
<td style="text-align: right;">121.93333</td>
<td style="text-align: right;">123.12000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2005-Q4</td>
<td style="text-align: right;">123.18667</td>
<td style="text-align: right;">123.35000</td>
</tr>
<tr class="even">
<td style="text-align: left;">2006-Q1</td>
<td style="text-align: right;">127.20333</td>
<td style="text-align: right;">128.52000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2006-Q2</td>
<td style="text-align: right;">129.64000</td>
<td style="text-align: right;">128.75333</td>
</tr>
<tr class="even">
<td style="text-align: left;">2006-Q3</td>
<td style="text-align: right;">128.63667</td>
<td style="text-align: right;">130.69000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2006-Q4</td>
<td style="text-align: right;">137.43000</td>
<td style="text-align: right;">139.98000</td>
</tr>
<tr class="even">
<td style="text-align: left;">2007-Q1</td>
<td style="text-align: right;">141.91333</td>
<td style="text-align: right;">142.22667</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2007-Q2</td>
<td style="text-align: right;">148.15333</td>
<td style="text-align: right;">150.68000</td>
</tr>
<tr class="even">
<td style="text-align: left;">2007-Q3</td>
<td style="text-align: right;">147.83333</td>
<td style="text-align: right;">148.63000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2007-Q4</td>
<td style="text-align: right;">151.36000</td>
<td style="text-align: right;">149.84000</td>
</tr>
<tr class="even">
<td style="text-align: left;">2008-Q1</td>
<td style="text-align: right;">139.20333</td>
<td style="text-align: right;">134.38667</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2008-Q2</td>
<td style="text-align: right;">137.27333</td>
<td style="text-align: right;">135.53000</td>
</tr>
<tr class="even">
<td style="text-align: left;">2008-Q3</td>
<td style="text-align: right;">127.89000</td>
<td style="text-align: right;">123.87000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2008-Q4</td>
<td style="text-align: right;">99.85333</td>
<td style="text-align: right;">92.38667</td>
</tr>
<tr class="even">
<td style="text-align: left;">2009-Q1</td>
<td style="text-align: right;">81.51000</td>
<td style="text-align: right;">78.76000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2009-Q2</td>
<td style="text-align: right;">86.54667</td>
<td style="text-align: right;">90.63333</td>
</tr>
<tr class="even">
<td style="text-align: left;">2009-Q3</td>
<td style="text-align: right;">98.04667</td>
<td style="text-align: right;">102.28667</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2009-Q4</td>
<td style="text-align: right;">106.01667</td>
<td style="text-align: right;">108.31333</td>
</tr>
<tr class="even">
<td style="text-align: left;">2010-Q1</td>
<td style="text-align: right;">110.57333</td>
<td style="text-align: right;">111.71000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2010-Q2</td>
<td style="text-align: right;">115.17667</td>
<td style="text-align: right;">110.46667</td>
</tr>
<tr class="even">
<td style="text-align: left;">2010-Q3</td>
<td style="text-align: right;">107.29000</td>
<td style="text-align: right;">109.90333</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2010-Q4</td>
<td style="text-align: right;">118.08667</td>
<td style="text-align: right;">120.91000</td>
</tr>
<tr class="even">
<td style="text-align: left;">2011-Q1</td>
<td style="text-align: right;">129.91333</td>
<td style="text-align: right;">131.47333</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2011-Q2</td>
<td style="text-align: right;">134.99667</td>
<td style="text-align: right;">134.43333</td>
</tr>
<tr class="even">
<td style="text-align: left;">2011-Q3</td>
<td style="text-align: right;">128.40667</td>
<td style="text-align: right;">121.56667</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2011-Q4</td>
<td style="text-align: right;">119.79000</td>
<td style="text-align: right;">125.33000</td>
</tr>
<tr class="even">
<td style="text-align: left;">2012-Q1</td>
<td style="text-align: right;">132.45333</td>
<td style="text-align: right;">136.38333</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2012-Q2</td>
<td style="text-align: right;">136.61333</td>
<td style="text-align: right;">135.81333</td>
</tr>
<tr class="even">
<td style="text-align: left;">2012-Q3</td>
<td style="text-align: right;">138.74000</td>
<td style="text-align: right;">140.94667</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2012-Q4</td>
<td style="text-align: right;">142.99000</td>
<td style="text-align: right;">141.97000</td>
</tr>
<tr class="even">
<td style="text-align: left;">2013-Q1</td>
<td style="text-align: right;">148.95000</td>
<td style="text-align: right;">152.66000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2013-Q2</td>
<td style="text-align: right;">159.91667</td>
<td style="text-align: right;">161.18333</td>
</tr>
<tr class="even">
<td style="text-align: left;">2013-Q3</td>
<td style="text-align: right;">165.49333</td>
<td style="text-align: right;">166.79000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2013-Q4</td>
<td style="text-align: right;">175.08333</td>
<td style="text-align: right;">180.49333</td>
</tr>
<tr class="even">
<td style="text-align: left;">2014-Q1</td>
<td style="text-align: right;">182.20000</td>
<td style="text-align: right;">183.82667</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2014-Q2</td>
<td style="text-align: right;">189.59667</td>
<td style="text-align: right;">192.23667</td>
</tr>
<tr class="even">
<td style="text-align: left;">2014-Q3</td>
<td style="text-align: right;">196.57667</td>
<td style="text-align: right;">196.94000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2014-Q4</td>
<td style="text-align: right;">201.67333</td>
<td style="text-align: right;">204.80000</td>
</tr>
<tr class="even">
<td style="text-align: left;">2015-Q1</td>
<td style="text-align: right;">205.73667</td>
<td style="text-align: right;">205.51333</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2015-Q2</td>
<td style="text-align: right;">209.25667</td>
<td style="text-align: right;">208.49667</td>
</tr>
<tr class="even">
<td style="text-align: left;">2015-Q3</td>
<td style="text-align: right;">203.77000</td>
<td style="text-align: right;">199.86000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2015-Q4</td>
<td style="text-align: right;">203.28000</td>
<td style="text-align: right;">206.83000</td>
</tr>
<tr class="even">
<td style="text-align: left;">2016-Q1</td>
<td style="text-align: right;">196.01000</td>
<td style="text-align: right;">197.60000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2016-Q2</td>
<td style="text-align: right;">206.79667</td>
<td style="text-align: right;">208.55000</td>
</tr>
<tr class="even">
<td style="text-align: left;">2016-Q3</td>
<td style="text-align: right;">214.68000</td>
<td style="text-align: right;">216.93333</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2016-Q4</td>
<td style="text-align: right;">216.49333</td>
<td style="text-align: right;">218.82000</td>
</tr>
<tr class="even">
<td style="text-align: left;">2017-Q1</td>
<td style="text-align: right;">230.32000</td>
<td style="text-align: right;">233.24667</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2017-Q2</td>
<td style="text-align: right;">238.81667</td>
<td style="text-align: right;">240.44000</td>
</tr>
<tr class="even">
<td style="text-align: left;">2017-Q3</td>
<td style="text-align: right;">246.08667</td>
<td style="text-align: right;">248.49667</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2017-Q4</td>
<td style="text-align: right;">258.09667</td>
<td style="text-align: right;">263.00667</td>
</tr>
<tr class="even">
<td style="text-align: left;">2018-Q1</td>
<td style="text-align: right;">273.44000</td>
<td style="text-align: right;">272.23333</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2018-Q2</td>
<td style="text-align: right;">266.27667</td>
<td style="text-align: right;">268.91000</td>
</tr>
<tr class="even">
<td style="text-align: left;">2018-Q3</td>
<td style="text-align: right;">280.30333</td>
<td style="text-align: right;">287.45333</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2018-Q4</td>
<td style="text-align: right;">281.33000</td>
<td style="text-align: right;">265.40000</td>
</tr>
<tr class="even">
<td style="text-align: left;">2019-Q1</td>
<td style="text-align: right;">265.52333</td>
<td style="text-align: right;">277.03000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2019-Q2</td>
<td style="text-align: right;">284.91000</td>
<td style="text-align: right;">287.43000</td>
</tr>
<tr class="even">
<td style="text-align: left;">2019-Q3</td>
<td style="text-align: right;">294.95000</td>
<td style="text-align: right;">295.55000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2019-Q4</td>
<td style="text-align: right;">305.75000</td>
<td style="text-align: right;">313.16667</td>
</tr>
<tr class="even">
<td style="text-align: left;">2020-Q1</td>
<td style="text-align: right;">315.03333</td>
<td style="text-align: right;">291.91333</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2020-Q2</td>
<td style="text-align: right;">278.97000</td>
<td style="text-align: right;">301.05333</td>
</tr>
<tr class="even">
<td style="text-align: left;">2020-Q3</td>
<td style="text-align: right;">329.36667</td>
<td style="text-align: right;">336.90667</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2020-Q4</td>
<td style="text-align: right;">344.48667</td>
<td style="text-align: right;">354.16000</td>
</tr>
<tr class="even">
<td style="text-align: left;">2021-Q1</td>
<td style="text-align: right;">378.20667</td>
<td style="text-align: right;">382.25333</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2021-Q2</td>
<td style="text-align: right;">413.46667</td>
<td style="text-align: right;">421.80000</td>
</tr>
<tr class="even">
<td style="text-align: left;">2021-Q3</td>
<td style="text-align: right;">440.59000</td>
<td style="text-align: right;">439.73667</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2021-Q4</td>
<td style="text-align: right;">450.97333</td>
<td style="text-align: right;">463.25667</td>
</tr>
<tr class="even">
<td style="text-align: left;">2022-Q1</td>
<td style="text-align: right;">454.00667</td>
<td style="text-align: right;">446.06000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2022-Q2</td>
<td style="text-align: right;">426.85000</td>
<td style="text-align: right;">400.72667</td>
</tr>
<tr class="even">
<td style="text-align: left;">2022-Q3</td>
<td style="text-align: right;">392.86667</td>
<td style="text-align: right;">388.11667</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2022-Q4</td>
<td style="text-align: right;">386.66333</td>
<td style="text-align: right;">392.10667</td>
</tr>
<tr class="even">
<td style="text-align: left;">2023-Q1</td>
<td style="text-align: right;">394.99700</td>
<td style="text-align: right;">404.04333</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2023-Q2</td>
<td style="text-align: right;">414.13667</td>
<td style="text-align: right;">425.68667</td>
</tr>
<tr class="even">
<td style="text-align: left;">2023-Q3</td>
<td style="text-align: right;">450.78667</td>
<td style="text-align: right;">445.20667</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2023-Q4</td>
<td style="text-align: right;">433.86333</td>
<td style="text-align: right;">449.97000</td>
</tr>
<tr class="even">
<td style="text-align: left;">2024-Q1</td>
<td style="text-align: right;">488.59000</td>
<td style="text-align: right;">504.67667</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2024-Q2</td>
<td style="text-align: right;">518.07667</td>
<td style="text-align: right;">524.52333</td>
</tr>
<tr class="even">
<td style="text-align: left;">2024-Q3</td>
<td style="text-align: right;">552.89000</td>
<td style="text-align: right;">562.75000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2024-Q4</td>
<td style="text-align: right;">582.56333</td>
<td style="text-align: right;">592.95000</td>
</tr>
</tbody>
</table>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert MSCI columns to numeric datatypes, create a year_quarter column, group "year_quarter" to calculate average open and close prices</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>data_msciquarterlyavg <span class="ot">&lt;-</span> data_msci <span class="sc">|&gt;</span> </span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">open =</span> <span class="fu">as.numeric</span>(open),</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">close =</span> <span class="fu">as.numeric</span>(close),</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">high =</span> <span class="fu">as.numeric</span>(high),</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">low =</span> <span class="fu">as.numeric</span>(low),</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">volume =</span> <span class="fu">as.numeric</span>(volume),</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">date =</span> <span class="fu">as.Date</span>(date),</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">year_quarter =</span> <span class="fu">paste</span>(<span class="fu">year</span>(date), <span class="st">"-Q"</span>, <span class="fu">quarter</span>(date), <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(year_quarter) <span class="sc">|&gt;</span> </span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_open =</span> <span class="fu">mean</span>(open, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_close =</span> <span class="fu">mean</span>(close, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">'drop'</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Year and Quarter</span><span class="st">`</span> <span class="ot">=</span> year_quarter,</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Average Open</span><span class="st">`</span> <span class="ot">=</span> avg_open,</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Average Close</span><span class="st">`</span> <span class="ot">=</span> avg_close</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the MSCI results as a table</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>data_msciquarterlyavg <span class="sc">|&gt;</span> <span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Year and Quarter</th>
<th style="text-align: right;">Average Open</th>
<th style="text-align: right;">Average Close</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2001-Q3</td>
<td style="text-align: right;">122.30000</td>
<td style="text-align: right;">112.90000</td>
</tr>
<tr class="even">
<td style="text-align: left;">2001-Q4</td>
<td style="text-align: right;">115.16667</td>
<td style="text-align: right;">117.60000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2002-Q1</td>
<td style="text-align: right;">115.86667</td>
<td style="text-align: right;">115.43333</td>
</tr>
<tr class="even">
<td style="text-align: left;">2002-Q2</td>
<td style="text-align: right;">121.96667</td>
<td style="text-align: right;">121.03333</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2002-Q3</td>
<td style="text-align: right;">109.26667</td>
<td style="text-align: right;">102.90000</td>
</tr>
<tr class="even">
<td style="text-align: left;">2002-Q4</td>
<td style="text-align: right;">99.91667</td>
<td style="text-align: right;">100.75333</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2003-Q1</td>
<td style="text-align: right;">96.43667</td>
<td style="text-align: right;">92.70000</td>
</tr>
<tr class="even">
<td style="text-align: left;">2003-Q2</td>
<td style="text-align: right;">99.69667</td>
<td style="text-align: right;">104.79000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2003-Q3</td>
<td style="text-align: right;">110.68333</td>
<td style="text-align: right;">113.50667</td>
</tr>
<tr class="even">
<td style="text-align: left;">2003-Q4</td>
<td style="text-align: right;">124.72333</td>
<td style="text-align: right;">129.71000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2004-Q1</td>
<td style="text-align: right;">139.31333</td>
<td style="text-align: right;">140.47333</td>
</tr>
<tr class="even">
<td style="text-align: left;">2004-Q2</td>
<td style="text-align: right;">139.65333</td>
<td style="text-align: right;">139.38667</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2004-Q3</td>
<td style="text-align: right;">139.36000</td>
<td style="text-align: right;">138.94333</td>
</tr>
<tr class="even">
<td style="text-align: left;">2004-Q4</td>
<td style="text-align: right;">148.29333</td>
<td style="text-align: right;">153.95000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2005-Q1</td>
<td style="text-align: right;">160.32667</td>
<td style="text-align: right;">159.74000</td>
</tr>
<tr class="even">
<td style="text-align: left;">2005-Q2</td>
<td style="text-align: right;">157.10333</td>
<td style="text-align: right;">121.21333</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2005-Q3</td>
<td style="text-align: right;">54.50333</td>
<td style="text-align: right;">56.03000</td>
</tr>
<tr class="even">
<td style="text-align: left;">2005-Q4</td>
<td style="text-align: right;">57.59333</td>
<td style="text-align: right;">57.74333</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2006-Q1</td>
<td style="text-align: right;">62.08333</td>
<td style="text-align: right;">63.40000</td>
</tr>
<tr class="even">
<td style="text-align: left;">2006-Q2</td>
<td style="text-align: right;">66.21333</td>
<td style="text-align: right;">66.28333</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2006-Q3</td>
<td style="text-align: right;">66.27333</td>
<td style="text-align: right;">67.09000</td>
</tr>
<tr class="even">
<td style="text-align: left;">2006-Q4</td>
<td style="text-align: right;">70.50333</td>
<td style="text-align: right;">71.98667</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2007-Q1</td>
<td style="text-align: right;">73.92667</td>
<td style="text-align: right;">74.89333</td>
</tr>
<tr class="even">
<td style="text-align: left;">2007-Q2</td>
<td style="text-align: right;">79.03000</td>
<td style="text-align: right;">80.32000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2007-Q3</td>
<td style="text-align: right;">79.44000</td>
<td style="text-align: right;">79.97667</td>
</tr>
<tr class="even">
<td style="text-align: left;">2007-Q4</td>
<td style="text-align: right;">83.44337</td>
<td style="text-align: right;">82.52667</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2008-Q1</td>
<td style="text-align: right;">74.52333</td>
<td style="text-align: right;">71.94670</td>
</tr>
<tr class="even">
<td style="text-align: left;">2008-Q2</td>
<td style="text-align: right;">74.79333</td>
<td style="text-align: right;">73.73000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2008-Q3</td>
<td style="text-align: right;">65.68333</td>
<td style="text-align: right;">62.08667</td>
</tr>
<tr class="even">
<td style="text-align: left;">2008-Q4</td>
<td style="text-align: right;">46.74667</td>
<td style="text-align: right;">43.72000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2009-Q1</td>
<td style="text-align: right;">38.73333</td>
<td style="text-align: right;">36.99000</td>
</tr>
<tr class="even">
<td style="text-align: left;">2009-Q2</td>
<td style="text-align: right;">42.62333</td>
<td style="text-align: right;">45.06000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2009-Q3</td>
<td style="text-align: right;">49.95000</td>
<td style="text-align: right;">52.59000</td>
</tr>
<tr class="even">
<td style="text-align: left;">2009-Q4</td>
<td style="text-align: right;">54.86000</td>
<td style="text-align: right;">54.65667</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2010-Q1</td>
<td style="text-align: right;">54.12000</td>
<td style="text-align: right;">53.69333</td>
</tr>
<tr class="even">
<td style="text-align: left;">2010-Q2</td>
<td style="text-align: right;">52.98333</td>
<td style="text-align: right;">49.74667</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2010-Q3</td>
<td style="text-align: right;">50.45000</td>
<td style="text-align: right;">52.25667</td>
</tr>
<tr class="even">
<td style="text-align: left;">2010-Q4</td>
<td style="text-align: right;">55.97000</td>
<td style="text-align: right;">56.49667</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2011-Q1</td>
<td style="text-align: right;">60.19000</td>
<td style="text-align: right;">60.35667</td>
</tr>
<tr class="even">
<td style="text-align: left;">2011-Q2</td>
<td style="text-align: right;">62.01333</td>
<td style="text-align: right;">61.88667</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2011-Q3</td>
<td style="text-align: right;">57.57667</td>
<td style="text-align: right;">53.35333</td>
</tr>
<tr class="even">
<td style="text-align: left;">2011-Q4</td>
<td style="text-align: right;">49.52000</td>
<td style="text-align: right;">51.05000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2012-Q1</td>
<td style="text-align: right;">52.78000</td>
<td style="text-align: right;">53.89667</td>
</tr>
<tr class="even">
<td style="text-align: left;">2012-Q2</td>
<td style="text-align: right;">51.73333</td>
<td style="text-align: right;">50.49000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2012-Q3</td>
<td style="text-align: right;">50.64000</td>
<td style="text-align: right;">51.53333</td>
</tr>
<tr class="even">
<td style="text-align: left;">2012-Q4</td>
<td style="text-align: right;">54.25333</td>
<td style="text-align: right;">55.16833</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2013-Q1</td>
<td style="text-align: right;">58.27667</td>
<td style="text-align: right;">58.72500</td>
</tr>
<tr class="even">
<td style="text-align: left;">2013-Q2</td>
<td style="text-align: right;">60.21667</td>
<td style="text-align: right;">59.77000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2013-Q3</td>
<td style="text-align: right;">59.81333</td>
<td style="text-align: right;">61.10700</td>
</tr>
<tr class="even">
<td style="text-align: left;">2013-Q4</td>
<td style="text-align: right;">65.13667</td>
<td style="text-align: right;">66.40500</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2014-Q1</td>
<td style="text-align: right;">65.38333</td>
<td style="text-align: right;">66.10667</td>
</tr>
<tr class="even">
<td style="text-align: left;">2014-Q2</td>
<td style="text-align: right;">68.54333</td>
<td style="text-align: right;">68.70000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2014-Q3</td>
<td style="text-align: right;">67.31667</td>
<td style="text-align: right;">65.80667</td>
</tr>
<tr class="even">
<td style="text-align: left;">2014-Q4</td>
<td style="text-align: right;">63.76667</td>
<td style="text-align: right;">62.92667</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2015-Q1</td>
<td style="text-align: right;">62.58667</td>
<td style="text-align: right;">63.49667</td>
</tr>
<tr class="even">
<td style="text-align: left;">2015-Q2</td>
<td style="text-align: right;">66.10833</td>
<td style="text-align: right;">65.54667</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2015-Q3</td>
<td style="text-align: right;">62.43667</td>
<td style="text-align: right;">60.69000</td>
</tr>
<tr class="even">
<td style="text-align: left;">2015-Q4</td>
<td style="text-align: right;">60.08333</td>
<td style="text-align: right;">60.16000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2016-Q1</td>
<td style="text-align: right;">55.75000</td>
<td style="text-align: right;">55.42333</td>
</tr>
<tr class="even">
<td style="text-align: left;">2016-Q2</td>
<td style="text-align: right;">57.66333</td>
<td style="text-align: right;">57.54333</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2016-Q3</td>
<td style="text-align: right;">57.44000</td>
<td style="text-align: right;">58.50500</td>
</tr>
<tr class="even">
<td style="text-align: left;">2016-Q4</td>
<td style="text-align: right;">57.88667</td>
<td style="text-align: right;">57.44667</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2017-Q1</td>
<td style="text-align: right;">59.56667</td>
<td style="text-align: right;">60.75333</td>
</tr>
<tr class="even">
<td style="text-align: left;">2017-Q2</td>
<td style="text-align: right;">64.16333</td>
<td style="text-align: right;">65.02000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2017-Q3</td>
<td style="text-align: right;">66.57000</td>
<td style="text-align: right;">67.43667</td>
</tr>
<tr class="even">
<td style="text-align: left;">2017-Q4</td>
<td style="text-align: right;">69.32000</td>
<td style="text-align: right;">70.01667</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2018-Q1</td>
<td style="text-align: right;">71.31667</td>
<td style="text-align: right;">71.26333</td>
</tr>
<tr class="even">
<td style="text-align: left;">2018-Q2</td>
<td style="text-align: right;">69.99667</td>
<td style="text-align: right;">69.03667</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2018-Q3</td>
<td style="text-align: right;">67.09667</td>
<td style="text-align: right;">68.07000</td>
</tr>
<tr class="even">
<td style="text-align: left;">2018-Q4</td>
<td style="text-align: right;">64.98667</td>
<td style="text-align: right;">61.33667</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2019-Q1</td>
<td style="text-align: right;">61.77667</td>
<td style="text-align: right;">63.93667</td>
</tr>
<tr class="even">
<td style="text-align: left;">2019-Q2</td>
<td style="text-align: right;">65.31000</td>
<td style="text-align: right;">65.29667</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2019-Q3</td>
<td style="text-align: right;">64.59000</td>
<td style="text-align: right;">64.29000</td>
</tr>
<tr class="even">
<td style="text-align: left;">2019-Q4</td>
<td style="text-align: right;">66.99000</td>
<td style="text-align: right;">68.34667</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2020-Q1</td>
<td style="text-align: right;">66.62000</td>
<td style="text-align: right;">61.06000</td>
</tr>
<tr class="even">
<td style="text-align: left;">2020-Q2</td>
<td style="text-align: right;">55.86333</td>
<td style="text-align: right;">59.02667</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2020-Q3</td>
<td style="text-align: right;">62.83667</td>
<td style="text-align: right;">63.56000</td>
</tr>
<tr class="even">
<td style="text-align: left;">2020-Q4</td>
<td style="text-align: right;">65.80667</td>
<td style="text-align: right;">68.16667</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2021-Q1</td>
<td style="text-align: right;">74.19000</td>
<td style="text-align: right;">74.09000</td>
</tr>
<tr class="even">
<td style="text-align: left;">2021-Q2</td>
<td style="text-align: right;">78.83667</td>
<td style="text-align: right;">79.27333</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2021-Q3</td>
<td style="text-align: right;">80.09667</td>
<td style="text-align: right;">79.38000</td>
</tr>
<tr class="even">
<td style="text-align: left;">2021-Q4</td>
<td style="text-align: right;">78.96333</td>
<td style="text-align: right;">78.67000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2022-Q1</td>
<td style="text-align: right;">76.11333</td>
<td style="text-align: right;">74.21333</td>
</tr>
<tr class="even">
<td style="text-align: left;">2022-Q2</td>
<td style="text-align: right;">70.95667</td>
<td style="text-align: right;">67.04667</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2022-Q3</td>
<td style="text-align: right;">62.73667</td>
<td style="text-align: right;">61.14333</td>
</tr>
<tr class="even">
<td style="text-align: left;">2022-Q4</td>
<td style="text-align: right;">61.65333</td>
<td style="text-align: right;">64.02333</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2023-Q1</td>
<td style="text-align: right;">69.28333</td>
<td style="text-align: right;">70.80667</td>
</tr>
<tr class="even">
<td style="text-align: left;">2023-Q2</td>
<td style="text-align: right;">72.14333</td>
<td style="text-align: right;">72.26333</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2023-Q3</td>
<td style="text-align: right;">72.78333</td>
<td style="text-align: right;">71.63667</td>
</tr>
<tr class="even">
<td style="text-align: left;">2023-Q4</td>
<td style="text-align: right;">69.30833</td>
<td style="text-align: right;">71.56333</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2024-Q1</td>
<td style="text-align: right;">75.76667</td>
<td style="text-align: right;">77.37333</td>
</tr>
<tr class="even">
<td style="text-align: left;">2024-Q2</td>
<td style="text-align: right;">79.47000</td>
<td style="text-align: right;">78.92667</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2024-Q3</td>
<td style="text-align: right;">80.22000</td>
<td style="text-align: right;">82.32333</td>
</tr>
<tr class="even">
<td style="text-align: left;">2024-Q4</td>
<td style="text-align: right;">80.79667</td>
<td style="text-align: right;">79.29667</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Now that we have visualized our data we can draw some conclusions.</p>
<p>From our wage growth and inflation data: it appears that when wage growth declines - such as during the 2008 financial crisis and the 2020 COVID pandemic - inflation also declines. The inverse is also true: when wages rise, inflation rises.</p>
<p>From our S&amp;P500 and MSCI data: Both stock indexes have continually grown with the exception of three notably large downturns; the first of which occurred in 2002, the second of which occurred in 2008, and the most recent of which occurred in 2020.</p>
</section>
<section id="task-5-historical-comparison" class="level2">
<h2 class="anchored" data-anchor-id="task-5-historical-comparison">TASK 5: Historical Comparison</h2>
<p>Now that we have acquired our data, we will begin getting into the “meat and potatoes” of our analysis. We will implement the TRS and ORP formulas and compare the values output by each of them for the first month of retirement. We will assume that our hypothetical employee joined CUNY in the first month of our historical data and retired from CUNY at the end of the final month of our historical data.</p>
<p>We will begin by implementing the TRS formula, which is chiefly based on an employee’s final three years salary.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Change the datatypes in the stock market data</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>data_sap500<span class="sc">$</span>open <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(data_sap500<span class="sc">$</span>open)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>data_sap500<span class="sc">$</span>close <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(data_sap500<span class="sc">$</span>close)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>data_msci<span class="sc">$</span>open <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(data_msci<span class="sc">$</span>open)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>data_msci<span class="sc">$</span>close <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(data_msci<span class="sc">$</span>close)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>data_shortdebts<span class="sc">$</span>date <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(data_shortdebts<span class="sc">$</span>date)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>data_shortdebts<span class="sc">$</span>value <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(data_shortdebts<span class="sc">$</span>value)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="co"># TRS Retirement Calculation</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>calculate_trs_retirement_benefit <span class="ot">&lt;-</span> <span class="cf">function</span>(salary_data, years_served, data_inflation, retirement_date) {</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># salary_data: A numeric vector of the employee's salary for the last 3 years</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># years_served: The number of years the employee has worked</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># data_inflation: A data frame containing 'date' and 'value' columns with CPI data</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># retirement_date: The employee's retirement date (as a Date object)</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 1. Calculate Final Average Salary (FAS) based on the last 3 years' salary</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>  FAS <span class="ot">&lt;-</span> <span class="fu">mean</span>(salary_data)</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 2. Calculate the base retirement benefit</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (years_served <span class="sc">&lt;=</span> <span class="dv">20</span>) {</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    base_benefit <span class="ot">&lt;-</span> <span class="fl">0.0167</span> <span class="sc">*</span> FAS <span class="sc">*</span> years_served</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (years_served <span class="sc">==</span> <span class="dv">20</span>) {</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    base_benefit <span class="ot">&lt;-</span> <span class="fl">0.0175</span> <span class="sc">*</span> FAS <span class="sc">*</span> years_served</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>    base_benefit <span class="ot">&lt;-</span> (<span class="fl">0.35</span> <span class="sc">+</span> <span class="fl">0.02</span> <span class="sc">*</span> years_served) <span class="sc">*</span> FAS</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 3. Convert 'retirement_date' to Date class if not already</span></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>  retirement_date <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(retirement_date)</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 4. Get CPI data for the period from January 2010 to the month of retirement</span></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>  data_inflation<span class="sc">$</span>date <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(data_inflation<span class="sc">$</span>date)  <span class="co"># Ensure 'date' is Date class</span></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Filter CPI data from January 2010 to the month of retirement</span></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>  cpi_period <span class="ot">&lt;-</span> data_inflation[data_inflation<span class="sc">$</span>date <span class="sc">&gt;=</span> <span class="st">"2010-01-01"</span> <span class="sc">&amp;</span> data_inflation<span class="sc">$</span>date <span class="sc">&lt;=</span> retirement_date, ]</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 5. Initialize inflation adjustment</span></span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>  inflation_adjustment <span class="ot">&lt;-</span> <span class="dv">0</span>  <span class="co"># Start with no inflation adjustment</span></span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Loop through each month in the CPI period and calculate inflation adjustment</span></span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(cpi_period)) {</span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>    avg_cpi <span class="ot">&lt;-</span> cpi_period<span class="sc">$</span>value[i]  <span class="co"># CPI for the current month</span></span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the inflation adjustment for the current month</span></span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>    monthly_inflation <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fl">0.5</span> <span class="sc">*</span> avg_cpi, <span class="dv">1</span>)  <span class="co"># 50% of the CPI, rounded to nearest 0.1%</span></span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>    monthly_inflation <span class="ot">&lt;-</span> <span class="fu">pmin</span>(<span class="fu">pmax</span>(monthly_inflation, <span class="dv">1</span>), <span class="dv">3</span>)  <span class="co"># cap between 1% and 3%</span></span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply the monthly inflation adjustment to the base benefit</span></span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>    base_benefit <span class="ot">&lt;-</span> base_benefit <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> monthly_inflation <span class="sc">/</span> <span class="dv">100</span>)</span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 6. Return the final adjusted retirement benefit</span></span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(base_benefit)</span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We continue our analysis by implementing the ORP formula, which is chiefly based on a traditional 401K retirement savings plan. Here, the employee and employer make contributions to a retirement account which is then invested in an employee’s choice of mutual funds. We will use a Fidelity Freedom Fund (FFF) to determine our asset allocation.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ORP Retirement Calculation </span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>calculate_orp <span class="ot">&lt;-</span> <span class="cf">function</span>(age, salary, start_date, end_date, data_sap500, data_msci, data_shortdebts) {</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Set asset allocation based on age range</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (age <span class="sc">&gt;=</span> <span class="dv">25</span> <span class="sc">&amp;&amp;</span> age <span class="sc">&lt;=</span> <span class="dv">49</span>) {</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    allocation <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">US =</span> <span class="fl">0.54</span>, <span class="at">International =</span> <span class="fl">0.36</span>, <span class="at">Bonds =</span> <span class="fl">0.10</span>, <span class="at">ShortDebt =</span> <span class="dv">0</span>)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (age <span class="sc">&gt;=</span> <span class="dv">50</span> <span class="sc">&amp;&amp;</span> age <span class="sc">&lt;=</span> <span class="dv">59</span>) {</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    allocation <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">US =</span> <span class="fl">0.47</span>, <span class="at">International =</span> <span class="fl">0.32</span>, <span class="at">Bonds =</span> <span class="fl">0.21</span>, <span class="at">ShortDebt =</span> <span class="dv">0</span>)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (age <span class="sc">&gt;=</span> <span class="dv">60</span> <span class="sc">&amp;&amp;</span> age <span class="sc">&lt;=</span> <span class="dv">74</span>) {</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    allocation <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">US =</span> <span class="fl">0.34</span>, <span class="at">International =</span> <span class="fl">0.23</span>, <span class="at">Bonds =</span> <span class="fl">0.43</span>, <span class="at">ShortDebt =</span> <span class="dv">0</span>)</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (age <span class="sc">&gt;=</span> <span class="dv">75</span>) {</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    allocation <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">US =</span> <span class="fl">0.19</span>, <span class="at">International =</span> <span class="fl">0.13</span>, <span class="at">Bonds =</span> <span class="fl">0.62</span>, <span class="at">ShortDebt =</span> <span class="fl">0.06</span>)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate market returns for each asset class</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>  us_returns <span class="ot">&lt;-</span> (data_sap500<span class="sc">$</span>close <span class="sc">-</span> data_sap500<span class="sc">$</span>open) <span class="sc">/</span> data_sap500<span class="sc">$</span>open</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>  international_returns <span class="ot">&lt;-</span> (data_msci<span class="sc">$</span>close <span class="sc">-</span> data_msci<span class="sc">$</span>open) <span class="sc">/</span> data_msci<span class="sc">$</span>open</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>  shortdebt_returns <span class="ot">&lt;-</span> <span class="fu">diff</span>(<span class="fu">log</span>(data_shortdebts<span class="sc">$</span>value)) <span class="co"># assuming logarithmic return</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>  bond_returns <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">length</span>(data_sap500<span class="sc">$</span>date)) <span class="co"># assuming bonds return 0 if not specified</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Salary-based contribution percentages</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (salary <span class="sc">&lt;=</span> <span class="dv">45000</span>) {</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>    emp_contrib_rate <span class="ot">&lt;-</span> <span class="fl">0.03</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (salary <span class="sc">&lt;=</span> <span class="dv">55000</span>) {</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>    emp_contrib_rate <span class="ot">&lt;-</span> <span class="fl">0.035</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (salary <span class="sc">&lt;=</span> <span class="dv">75000</span>) {</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>    emp_contrib_rate <span class="ot">&lt;-</span> <span class="fl">0.045</span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (salary <span class="sc">&lt;=</span> <span class="dv">100000</span>) {</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>    emp_contrib_rate <span class="ot">&lt;-</span> <span class="fl">0.0575</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>    emp_contrib_rate <span class="ot">&lt;-</span> <span class="fl">0.06</span></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Employer contribution rate (8% for first 7 years, 10% thereafter)</span></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>  employer_contrib_rate <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(age <span class="sc">&lt;=</span> <span class="dv">31</span>, <span class="fl">0.08</span>, <span class="fl">0.10</span>)  <span class="co"># assuming employment starts at age 25</span></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Initial account balance</span></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>  account_balance <span class="ot">&lt;-</span> <span class="dv">0</span>  <span class="co"># Starting with no balance</span></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Monthly contributions (employee + employer)</span></span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>  emp_monthly_contrib <span class="ot">&lt;-</span> (emp_contrib_rate <span class="sc">*</span> salary) <span class="sc">/</span> <span class="dv">12</span></span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>  employer_monthly_contrib <span class="ot">&lt;-</span> (employer_contrib_rate <span class="sc">*</span> salary) <span class="sc">/</span> <span class="dv">12</span></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Withdrawals (4% annually, divided monthly)</span></span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>  annual_withdrawal_rate <span class="ot">&lt;-</span> <span class="fl">0.04</span></span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>  monthly_withdrawal <span class="ot">&lt;-</span> (annual_withdrawal_rate <span class="sc">*</span> salary) <span class="sc">/</span> <span class="dv">12</span></span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Date range for simulation</span></span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>  date_range <span class="ot">&lt;-</span> <span class="fu">seq.Date</span>(<span class="fu">as.Date</span>(start_date), <span class="fu">as.Date</span>(end_date), <span class="at">by =</span> <span class="st">"month"</span>)</span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Loop over each month</span></span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(date_range)) {</span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Monthly contributions</span></span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a>    account_balance <span class="ot">&lt;-</span> account_balance <span class="sc">+</span> emp_monthly_contrib <span class="sc">+</span> employer_monthly_contrib</span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply asset allocation returns</span></span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a>    us_growth <span class="ot">&lt;-</span> allocation[<span class="st">"US"</span>] <span class="sc">*</span> us_returns[i <span class="sc">%%</span> <span class="fu">length</span>(us_returns) <span class="sc">+</span> <span class="dv">1</span>]  <span class="co"># Wrap around if less than the number of months</span></span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a>    international_growth <span class="ot">&lt;-</span> allocation[<span class="st">"International"</span>] <span class="sc">*</span> international_returns[i <span class="sc">%%</span> <span class="fu">length</span>(international_returns) <span class="sc">+</span> <span class="dv">1</span>]</span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a>    bond_growth <span class="ot">&lt;-</span> allocation[<span class="st">"Bonds"</span>] <span class="sc">*</span> bond_returns[i <span class="sc">%%</span> <span class="fu">length</span>(bond_returns) <span class="sc">+</span> <span class="dv">1</span>]</span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a>    shortdebt_growth <span class="ot">&lt;-</span> allocation[<span class="st">"ShortDebt"</span>] <span class="sc">*</span> shortdebt_returns[i <span class="sc">%%</span> <span class="fu">length</span>(shortdebt_returns) <span class="sc">+</span> <span class="dv">1</span>]</span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Update account balance with growth</span></span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a>    account_balance <span class="ot">&lt;-</span> account_balance <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> us_growth <span class="sc">+</span> international_growth <span class="sc">+</span> bond_growth <span class="sc">+</span> shortdebt_growth)</span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Monthly withdrawal</span></span>
<span id="cb12-65"><a href="#cb12-65" aria-hidden="true" tabindex="-1"></a>    account_balance <span class="ot">&lt;-</span> account_balance <span class="sc">-</span> monthly_withdrawal</span>
<span id="cb12-66"><a href="#cb12-66" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-67"><a href="#cb12-67" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-68"><a href="#cb12-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(account_balance)</span>
<span id="cb12-69"><a href="#cb12-69" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Once we have implemented the TRS and ORP formulas, we will use two “test cases” to test the outputs of our formulas and see which plan yields a higher retirement income. For this analysis, we need to make sure our “test cases” are the exact same - or very similar - people.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># TRS Retirement Example</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>salary_data <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">70000</span>, <span class="dv">75000</span>, <span class="dv">80000</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>years_served <span class="ot">&lt;-</span> <span class="dv">14</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>retirement_date <span class="ot">&lt;-</span> <span class="st">"2024-02-09"</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>adjusted_benefit <span class="ot">&lt;-</span> <span class="fu">calculate_trs_retirement_benefit</span>(salary_data, years_served, data_inflation, retirement_date)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"The TRS Retirement balance in month 1 is"</span>, adjusted_benefit, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="do">## The TRS Retirement balance in month 1 is 31164.32</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="co"># ORP Example</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>age <span class="ot">&lt;-</span> <span class="dv">75</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>salary <span class="ot">&lt;-</span> <span class="dv">80000</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>start_date <span class="ot">&lt;-</span> <span class="st">"2010-01-01"</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>end_date <span class="ot">&lt;-</span> <span class="st">"2024-02-09"</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>final_balance <span class="ot">&lt;-</span> <span class="fu">calculate_orp</span>(age, salary, start_date, end_date, data_sap500, data_msci, data_shortdebts)</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"The ORP balance in month 1 is"</span>, <span class="fu">round</span>(final_balance, <span class="dv">2</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a><span class="do">## The ORP balance in month 1 is 173120.2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>As we can see from our outputs, the ORP balance in the first month is higher; but this does not necessarily mean the plan is better. Let’s continue our analysis with some more data on our “test cases”.</p>
</section>
<section id="task-6-fixed-rate-analysis" class="level2">
<h2 class="anchored" data-anchor-id="task-6-fixed-rate-analysis">TASK 6: Fixed-Rate Analysis</h2>
<p>Let’s modify our simulation from the previous section to project an employee’s pension benefit (TRS) or withdrawal amount (ORP) from retirement up to death. In order to do this, we will need to implement estimated cost of living adjustments (COLA) (TRS) and future market returns (ORP). To predict these adjustments, we will use computed long-run averages in our functions.</p>
<p>We will begin by implementing the TRS formula, which ensures an employee is paid a monthly pension until their death.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>calculate_trs_retirement_benefit <span class="ot">&lt;-</span> <span class="cf">function</span>(salary_data, years_served, data_inflation, retirement_date, life_expectancy_years) {</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># salary_data: A numeric vector of the employee's salary for the last 3 years</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># years_served: The number of years the employee has worked</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># data_inflation: A data frame containing 'date' and 'value' columns with CPI data</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># retirement_date: The employee's retirement date (as a Date object)</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># life_expectancy_years: The expected years the employee will live post-retirement (default = 30)</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 1. Calculate Final Average Salary (FAS) based on the last 3 years' salary</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  FAS <span class="ot">&lt;-</span> <span class="fu">mean</span>(salary_data)</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 2. Calculate the base retirement benefit</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (years_served <span class="sc">&lt;=</span> <span class="dv">20</span>) {</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    base_benefit <span class="ot">&lt;-</span> <span class="fl">0.0167</span> <span class="sc">*</span> FAS <span class="sc">*</span> years_served</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (years_served <span class="sc">==</span> <span class="dv">20</span>) {</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    base_benefit <span class="ot">&lt;-</span> <span class="fl">0.0175</span> <span class="sc">*</span> FAS <span class="sc">*</span> years_served</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    base_benefit <span class="ot">&lt;-</span> (<span class="fl">0.35</span> <span class="sc">+</span> <span class="fl">0.02</span> <span class="sc">*</span> years_served) <span class="sc">*</span> FAS</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 3. Convert 'retirement_date' to Date class if not already</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>  retirement_date <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(retirement_date)</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 4. Get CPI data for the period from January 2010 to the year of retirement</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>  data_inflation<span class="sc">$</span>date <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(data_inflation<span class="sc">$</span>date)  <span class="co"># Ensure 'date' is Date class</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Filter CPI data from January 2010 to the year of retirement</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>  cpi_period <span class="ot">&lt;-</span> data_inflation[data_inflation<span class="sc">$</span>date <span class="sc">&gt;=</span> <span class="st">"2010-01-01"</span> <span class="sc">&amp;</span> data_inflation<span class="sc">$</span>date <span class="sc">&lt;=</span> retirement_date, ]</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 5. Calculate the average inflation over the last 3 years</span></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>  start_date <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(<span class="fu">format</span>(retirement_date, <span class="st">"%Y-01-01"</span>)) <span class="sc">-</span> <span class="dv">365</span> <span class="sc">*</span> <span class="dv">3</span>  <span class="co"># Calculate the date 3 years before retirement</span></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>  inflation_period <span class="ot">&lt;-</span> data_inflation[data_inflation<span class="sc">$</span>date <span class="sc">&gt;=</span> start_date, ]</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>  avg_inflation <span class="ot">&lt;-</span> <span class="fu">mean</span>(inflation_period<span class="sc">$</span>value) <span class="sc">/</span> <span class="dv">100</span>  <span class="co"># Convert CPI to decimal (e.g., 2.5% -&gt; 0.025)</span></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 6. Apply inflation adjustments annually and project pension benefit until death</span></span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>  projected_benefit <span class="ot">&lt;-</span> <span class="fu">numeric</span>(life_expectancy_years)</span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>  projected_benefit[<span class="dv">1</span>] <span class="ot">&lt;-</span> base_benefit  <span class="co"># Initial benefit at retirement</span></span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Project the benefit over the years of retirement</span></span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (year <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>life_expectancy_years) {</span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply COLA adjustment annually</span></span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>    adjusted_benefit <span class="ot">&lt;-</span> projected_benefit[year <span class="sc">-</span> <span class="dv">1</span>] <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> avg_inflation)</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>    projected_benefit[year] <span class="ot">&lt;-</span> adjusted_benefit</span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 7. Calculate the total projected pension benefit over the retirement period</span></span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>  total_projected_benefit <span class="ot">&lt;-</span> <span class="fu">sum</span>(projected_benefit)</span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 8. Return the projected pension benefit over the retirement period and the total sum</span></span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">projected_benefit =</span> projected_benefit,  <span class="co"># Return the projected benefits for each year</span></span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_projected_benefit =</span> total_projected_benefit  <span class="co"># Return the total sum of projected benefits</span></span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We continue our analysis by implementing the ORP formula, under which an employee is paid out 4% of the remaining yearly balance in their ORP account until they are either deceased or run out of funds.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>calculate_orp <span class="ot">&lt;-</span> <span class="cf">function</span>(age, salary, start_date, data_sap500, data_msci, data_shortdebts, life_expectancy) {</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Set asset allocation based on age range</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (age <span class="sc">&gt;=</span> <span class="dv">25</span> <span class="sc">&amp;&amp;</span> age <span class="sc">&lt;=</span> <span class="dv">49</span>) {</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    allocation <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">US =</span> <span class="fl">0.54</span>, <span class="at">International =</span> <span class="fl">0.36</span>, <span class="at">Bonds =</span> <span class="fl">0.10</span>, <span class="at">ShortDebt =</span> <span class="dv">0</span>)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (age <span class="sc">&gt;=</span> <span class="dv">50</span> <span class="sc">&amp;&amp;</span> age <span class="sc">&lt;=</span> <span class="dv">59</span>) {</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    allocation <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">US =</span> <span class="fl">0.47</span>, <span class="at">International =</span> <span class="fl">0.32</span>, <span class="at">Bonds =</span> <span class="fl">0.21</span>, <span class="at">ShortDebt =</span> <span class="dv">0</span>)</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (age <span class="sc">&gt;=</span> <span class="dv">60</span> <span class="sc">&amp;&amp;</span> age <span class="sc">&lt;=</span> <span class="dv">74</span>) {</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    allocation <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">US =</span> <span class="fl">0.34</span>, <span class="at">International =</span> <span class="fl">0.23</span>, <span class="at">Bonds =</span> <span class="fl">0.43</span>, <span class="at">ShortDebt =</span> <span class="dv">0</span>)</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (age <span class="sc">&gt;=</span> <span class="dv">75</span>) {</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    allocation <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">US =</span> <span class="fl">0.19</span>, <span class="at">International =</span> <span class="fl">0.13</span>, <span class="at">Bonds =</span> <span class="fl">0.62</span>, <span class="at">ShortDebt =</span> <span class="fl">0.06</span>)</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate long-run average market returns for each asset class (e.g., last 10 years)</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>  us_avg_return <span class="ot">&lt;-</span> <span class="fu">mean</span>((data_sap500<span class="sc">$</span>close <span class="sc">-</span> data_sap500<span class="sc">$</span>open) <span class="sc">/</span> data_sap500<span class="sc">$</span>open, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>  international_avg_return <span class="ot">&lt;-</span> <span class="fu">mean</span>((data_msci<span class="sc">$</span>close <span class="sc">-</span> data_msci<span class="sc">$</span>open) <span class="sc">/</span> data_msci<span class="sc">$</span>open, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>  shortdebt_avg_return <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">diff</span>(<span class="fu">log</span>(data_shortdebts<span class="sc">$</span>value)), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>  bond_avg_return <span class="ot">&lt;-</span> <span class="dv">0</span>  <span class="co"># assuming bonds return 0 if not specified</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Salary-based contribution percentages</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (salary <span class="sc">&lt;=</span> <span class="dv">45000</span>) {</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>    emp_contrib_rate <span class="ot">&lt;-</span> <span class="fl">0.03</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (salary <span class="sc">&lt;=</span> <span class="dv">55000</span>) {</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>    emp_contrib_rate <span class="ot">&lt;-</span> <span class="fl">0.035</span></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (salary <span class="sc">&lt;=</span> <span class="dv">75000</span>) {</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>    emp_contrib_rate <span class="ot">&lt;-</span> <span class="fl">0.045</span></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (salary <span class="sc">&lt;=</span> <span class="dv">100000</span>) {</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>    emp_contrib_rate <span class="ot">&lt;-</span> <span class="fl">0.0575</span></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>    emp_contrib_rate <span class="ot">&lt;-</span> <span class="fl">0.06</span></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Employer contribution rate (8% for first 7 years, 10% thereafter)</span></span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>  employer_contrib_rate <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(age <span class="sc">&lt;=</span> <span class="dv">31</span>, <span class="fl">0.08</span>, <span class="fl">0.10</span>)  <span class="co"># assuming employment starts at age 25</span></span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Initial account balance</span></span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>  account_balance <span class="ot">&lt;-</span> <span class="dv">0</span>  <span class="co"># Starting with no balance</span></span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Monthly contributions (employee + employer)</span></span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>  emp_monthly_contrib <span class="ot">&lt;-</span> (emp_contrib_rate <span class="sc">*</span> salary) <span class="sc">/</span> <span class="dv">12</span></span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>  employer_monthly_contrib <span class="ot">&lt;-</span> (employer_contrib_rate <span class="sc">*</span> salary) <span class="sc">/</span> <span class="dv">12</span></span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Withdrawals (4% annually, divided monthly)</span></span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a>  annual_withdrawal_rate <span class="ot">&lt;-</span> <span class="fl">0.04</span></span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a>  monthly_withdrawal <span class="ot">&lt;-</span> (annual_withdrawal_rate <span class="sc">*</span> salary) <span class="sc">/</span> <span class="dv">12</span></span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Estimate number of months until the employee's death</span></span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a>  months_until_death <span class="ot">&lt;-</span> (life_expectancy <span class="sc">-</span> age) <span class="sc">*</span> <span class="dv">12</span></span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a>  date_range <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">1</span>, months_until_death)  <span class="co"># We simulate each month</span></span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Loop over each month</span></span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(date_range)) {</span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Monthly contributions</span></span>
<span id="cb15-54"><a href="#cb15-54" aria-hidden="true" tabindex="-1"></a>    account_balance <span class="ot">&lt;-</span> account_balance <span class="sc">+</span> emp_monthly_contrib <span class="sc">+</span> employer_monthly_contrib</span>
<span id="cb15-55"><a href="#cb15-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-56"><a href="#cb15-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply asset allocation returns (using long-run average returns)</span></span>
<span id="cb15-57"><a href="#cb15-57" aria-hidden="true" tabindex="-1"></a>    us_growth <span class="ot">&lt;-</span> allocation[<span class="st">"US"</span>] <span class="sc">*</span> us_avg_return</span>
<span id="cb15-58"><a href="#cb15-58" aria-hidden="true" tabindex="-1"></a>    international_growth <span class="ot">&lt;-</span> allocation[<span class="st">"International"</span>] <span class="sc">*</span> international_avg_return</span>
<span id="cb15-59"><a href="#cb15-59" aria-hidden="true" tabindex="-1"></a>    bond_growth <span class="ot">&lt;-</span> allocation[<span class="st">"Bonds"</span>] <span class="sc">*</span> bond_avg_return</span>
<span id="cb15-60"><a href="#cb15-60" aria-hidden="true" tabindex="-1"></a>    shortdebt_growth <span class="ot">&lt;-</span> allocation[<span class="st">"ShortDebt"</span>] <span class="sc">*</span> shortdebt_avg_return</span>
<span id="cb15-61"><a href="#cb15-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-62"><a href="#cb15-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Update account balance with growth</span></span>
<span id="cb15-63"><a href="#cb15-63" aria-hidden="true" tabindex="-1"></a>    account_balance <span class="ot">&lt;-</span> account_balance <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> us_growth <span class="sc">+</span> international_growth <span class="sc">+</span> bond_growth <span class="sc">+</span> shortdebt_growth)</span>
<span id="cb15-64"><a href="#cb15-64" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-65"><a href="#cb15-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Monthly withdrawal</span></span>
<span id="cb15-66"><a href="#cb15-66" aria-hidden="true" tabindex="-1"></a>    account_balance <span class="ot">&lt;-</span> account_balance <span class="sc">-</span> monthly_withdrawal</span>
<span id="cb15-67"><a href="#cb15-67" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-68"><a href="#cb15-68" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure account balance does not go negative (you can't withdraw more than available)</span></span>
<span id="cb15-69"><a href="#cb15-69" aria-hidden="true" tabindex="-1"></a>    account_balance <span class="ot">&lt;-</span> <span class="fu">max</span>(account_balance, <span class="dv">0</span>)</span>
<span id="cb15-70"><a href="#cb15-70" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb15-71"><a href="#cb15-71" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-72"><a href="#cb15-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(account_balance)</span>
<span id="cb15-73"><a href="#cb15-73" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now that we have implemented the TRS and ORP formulas, we will use the same two “test cases” from our previous task to see which plan yields a higher retirement income until death. For this analysis, we still need to make sure our “test cases” are the exact same or very similar people.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Projected total TRS pension</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>salary_data <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">70000</span>, <span class="dv">75000</span>, <span class="dv">80000</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>years_served <span class="ot">&lt;-</span> <span class="dv">14</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>retirement_date <span class="ot">&lt;-</span> <span class="st">"2010-02-09"</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>life_expectancy_years <span class="ot">=</span> <span class="dv">80</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">calculate_trs_retirement_benefit</span>(salary_data, years_served, data_inflation, retirement_date, life_expectancy_years)</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"The total projected TRS pension benefit is"</span>, result<span class="sc">$</span>total_projected_benefit, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="do">## The total projected TRS pension benefit is 1812254</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Projected total ORP amount</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>age <span class="ot">&lt;-</span> <span class="dv">66</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>salary <span class="ot">&lt;-</span> <span class="dv">80000</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>start_date <span class="ot">&lt;-</span> <span class="st">"2010-02-09"</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>life_expectancy <span class="ot">=</span> <span class="dv">80</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>final_balance <span class="ot">&lt;-</span> <span class="fu">calculate_orp</span>(age, salary, start_date, data_sap500, data_msci, data_shortdebts, life_expectancy)</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"The total projected ORP withdrawl amount is"</span>, final_balance, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a><span class="do">## The total projected ORP withdrawl amount is 148947</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Under our new analysis, the TRS plan nets more retirement income until death than the ORP plan; the opposite result of our analysis from the previous task. With one advantage for the TRS plan and one advantage for the ORP plan, only one question remains: which plan is truly the biggest moneymaker?</p>
</section>
<section id="task-7-monte-carlo-analysis" class="level2">
<h2 class="anchored" data-anchor-id="task-7-monte-carlo-analysis">TASK 7: Monte Carlo Analysis</h2>
<p>To conduct our Monte Carlo Analysis, we are going to combine our formulas from the previous two tasks to calculate how much money an amount of hypothetical employees saves during employment, and thus receives during retirement under the TRS and ORP plans. To create our hypothetical employees, we will use a bootstrap method of creating 200 or more sample employees (or sample points) from which we can extract probability values. We will also create histograms of our simulations to make visualizing the results easier.</p>
<p>To start, lets work with our TRS formulas. We will combine the previous two formulas into a “while working” sum and a “retirement deficit”, which will then be summed to determine an overall value for each Monte Carlo sample passed into our formula.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># TRS Bootstrap Analysis</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)  <span class="co"># Set seed for reproducibility</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to generate synthetic salary data for an employee</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>generate_salary_data <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Simulating last 3 years of salary data (e.g., between $40,000 and $80,000)</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sample</span>(<span class="fu">seq</span>(<span class="dv">40000</span>, <span class="dv">80000</span>, <span class="at">by =</span> <span class="dv">500</span>), <span class="dv">3</span>)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to generate synthetic life expectancy data</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>generate_life_expectancy <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Assume life expectancy between 25 and 35 years post-retirement</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sample</span>(<span class="dv">25</span><span class="sc">:</span><span class="dv">35</span>, <span class="dv">1</span>)</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Monte Carlo Simulation to generate 200 bootstrap histories</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>n_simulations <span class="ot">&lt;-</span> <span class="dv">200</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>bootstrap_histories <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_simulations) {</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate synthetic data</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>  salary_data <span class="ot">&lt;-</span> <span class="fu">generate_salary_data</span>()</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>  years_served <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">10</span><span class="sc">:</span><span class="dv">35</span>, <span class="dv">1</span>)  <span class="co"># Random years of service between 10 and 35</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>  retirement_date <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(<span class="st">"2024-12-01"</span>) <span class="sc">-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">365</span>, <span class="dv">1</span>)  <span class="co"># Random retirement date in 2024</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Simulate life expectancy</span></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>  life_expectancy_years <span class="ot">&lt;-</span> <span class="fu">generate_life_expectancy</span>()</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Run the retirement benefit calculation function (using second function with life expectancy)</span></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">calculate_trs_retirement_benefit</span>(salary_data, years_served, data_inflation, retirement_date, life_expectancy_years)</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Store the result</span></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>  bootstrap_histories[[i]] <span class="ot">&lt;-</span> result</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Printing some summary statistics of the total projected benefits</span></span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>total_benefits <span class="ot">&lt;-</span> <span class="fu">sapply</span>(bootstrap_histories, <span class="cf">function</span>(x) x<span class="sc">$</span>total_projected_benefit)</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(total_benefits)</span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a><span class="do">##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a><span class="do">##  273893  608654 1564213 1417916 2077645 3134845</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now, let’s visualize the results of our simulation in a histogram with mean and median.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract the total projected benefits from all simulations</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>total_benefits <span class="ot">&lt;-</span> <span class="fu">sapply</span>(bootstrap_histories, <span class="cf">function</span>(x) x<span class="sc">$</span>total_projected_benefit)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to a data frame for ggplot2</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>benefits_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">total_benefit =</span> total_benefits)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a histogram of the total projected benefits</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(benefits_df, <span class="fu">aes</span>(<span class="at">x =</span> total_benefit)) <span class="sc">+</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="dv">50000</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">fill =</span> <span class="st">"black"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Distribution of TRS Total Projected Retirement Benefits (200 Simulations)"</span>,</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Total Projected Benefit ($)"</span>,</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Frequency"</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>)</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add summary statistics (mean and 95% CI)</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept =</span> <span class="fu">mean</span>(total_benefits)), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept =</span> <span class="fu">median</span>(total_benefits)), <span class="at">color =</span> <span class="st">"green"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="fu">mean</span>(total_benefits), <span class="at">y =</span> <span class="dv">5</span>, <span class="at">label =</span> <span class="fu">paste</span>(<span class="st">"Mean:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(total_benefits), <span class="dv">2</span>)), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">hjust =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="fu">median</span>(total_benefits), <span class="at">y =</span> <span class="dv">5</span>, <span class="at">label =</span> <span class="fu">paste</span>(<span class="st">"Median:"</span>, <span class="fu">round</span>(<span class="fu">median</span>(total_benefits), <span class="dv">2</span>)), <span class="at">color =</span> <span class="st">"green"</span>, <span class="at">hjust =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="mp04_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Continuing with our analysis, lets work with our ORP formulas. Similar to what we did with our TRS formulas, we will combine the previous two ORP formulas into a “while working” sum and a “retirement deficit”, which will then be summed to determine an overall value for each Monte Carlo sample passed into our formula.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ORP Bootstrap Analysis</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)  <span class="co"># Set a seed for reproducibility</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to calculate final balance from ORP (with asset returns)</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>calculate_orp <span class="ot">&lt;-</span> <span class="cf">function</span>(age, salary, start_date, data_sap500, data_msci, data_shortdebts, life_expectancy) {</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Set asset allocation based on age range</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (age <span class="sc">&gt;=</span> <span class="dv">25</span> <span class="sc">&amp;&amp;</span> age <span class="sc">&lt;=</span> <span class="dv">49</span>) {</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    allocation <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">US =</span> <span class="fl">0.54</span>, <span class="at">International =</span> <span class="fl">0.36</span>, <span class="at">Bonds =</span> <span class="fl">0.10</span>, <span class="at">ShortDebt =</span> <span class="dv">0</span>)</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (age <span class="sc">&gt;=</span> <span class="dv">50</span> <span class="sc">&amp;&amp;</span> age <span class="sc">&lt;=</span> <span class="dv">59</span>) {</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    allocation <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">US =</span> <span class="fl">0.47</span>, <span class="at">International =</span> <span class="fl">0.32</span>, <span class="at">Bonds =</span> <span class="fl">0.21</span>, <span class="at">ShortDebt =</span> <span class="dv">0</span>)</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (age <span class="sc">&gt;=</span> <span class="dv">60</span> <span class="sc">&amp;&amp;</span> age <span class="sc">&lt;=</span> <span class="dv">74</span>) {</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    allocation <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">US =</span> <span class="fl">0.34</span>, <span class="at">International =</span> <span class="fl">0.23</span>, <span class="at">Bonds =</span> <span class="fl">0.43</span>, <span class="at">ShortDebt =</span> <span class="dv">0</span>)</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (age <span class="sc">&gt;=</span> <span class="dv">75</span>) {</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    allocation <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">US =</span> <span class="fl">0.19</span>, <span class="at">International =</span> <span class="fl">0.13</span>, <span class="at">Bonds =</span> <span class="fl">0.62</span>, <span class="at">ShortDebt =</span> <span class="fl">0.06</span>)</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate monthly returns for each asset class</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>  us_returns <span class="ot">&lt;-</span> (data_sap500<span class="sc">$</span>close <span class="sc">-</span> data_sap500<span class="sc">$</span>open) <span class="sc">/</span> data_sap500<span class="sc">$</span>open</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>  international_returns <span class="ot">&lt;-</span> (data_msci<span class="sc">$</span>close <span class="sc">-</span> data_msci<span class="sc">$</span>open) <span class="sc">/</span> data_msci<span class="sc">$</span>open</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>  shortdebt_returns <span class="ot">&lt;-</span> <span class="fu">diff</span>(<span class="fu">log</span>(data_shortdebts<span class="sc">$</span>value))  <span class="co"># Logarithmic return for short-term debt</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Salary-based contribution percentages</span></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (salary <span class="sc">&lt;=</span> <span class="dv">45000</span>) {</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>    emp_contrib_rate <span class="ot">&lt;-</span> <span class="fl">0.03</span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (salary <span class="sc">&lt;=</span> <span class="dv">55000</span>) {</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>    emp_contrib_rate <span class="ot">&lt;-</span> <span class="fl">0.035</span></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (salary <span class="sc">&lt;=</span> <span class="dv">75000</span>) {</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>    emp_contrib_rate <span class="ot">&lt;-</span> <span class="fl">0.045</span></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (salary <span class="sc">&lt;=</span> <span class="dv">100000</span>) {</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>    emp_contrib_rate <span class="ot">&lt;-</span> <span class="fl">0.0575</span></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>    emp_contrib_rate <span class="ot">&lt;-</span> <span class="fl">0.06</span></span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Employer contribution rate (8% for first 7 years, 10% thereafter)</span></span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>  employer_contrib_rate <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(age <span class="sc">&lt;=</span> <span class="dv">31</span>, <span class="fl">0.08</span>, <span class="fl">0.10</span>)  <span class="co"># assuming employment starts at age 25</span></span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Initial account balance</span></span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>  account_balance <span class="ot">&lt;-</span> <span class="dv">0</span>  <span class="co"># Starting with no balance</span></span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Monthly contributions (employee + employer)</span></span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>  emp_monthly_contrib <span class="ot">&lt;-</span> (emp_contrib_rate <span class="sc">*</span> salary) <span class="sc">/</span> <span class="dv">12</span></span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>  employer_monthly_contrib <span class="ot">&lt;-</span> (employer_contrib_rate <span class="sc">*</span> salary) <span class="sc">/</span> <span class="dv">12</span></span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Withdrawals (4% annually, divided monthly)</span></span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a>  annual_withdrawal_rate <span class="ot">&lt;-</span> <span class="fl">0.04</span></span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a>  monthly_withdrawal <span class="ot">&lt;-</span> (annual_withdrawal_rate <span class="sc">*</span> salary) <span class="sc">/</span> <span class="dv">12</span></span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Estimate number of months until the employee's death</span></span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a>  months_until_death <span class="ot">&lt;-</span> (life_expectancy <span class="sc">-</span> age) <span class="sc">*</span> <span class="dv">12</span></span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a>  date_range <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">1</span>, months_until_death)  <span class="co"># We simulate each month</span></span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Loop over each month</span></span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(date_range)) {</span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Monthly contributions</span></span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a>    account_balance <span class="ot">&lt;-</span> account_balance <span class="sc">+</span> emp_monthly_contrib <span class="sc">+</span> employer_monthly_contrib</span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-59"><a href="#cb19-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply asset allocation returns (monthly returns)</span></span>
<span id="cb19-60"><a href="#cb19-60" aria-hidden="true" tabindex="-1"></a>    us_growth <span class="ot">&lt;-</span> allocation[<span class="st">"US"</span>] <span class="sc">*</span> us_returns[i <span class="sc">%%</span> <span class="fu">length</span>(us_returns) <span class="sc">+</span> <span class="dv">1</span>]  <span class="co"># Wrap around if less than the number of months</span></span>
<span id="cb19-61"><a href="#cb19-61" aria-hidden="true" tabindex="-1"></a>    international_growth <span class="ot">&lt;-</span> allocation[<span class="st">"International"</span>] <span class="sc">*</span> international_returns[i <span class="sc">%%</span> <span class="fu">length</span>(international_returns) <span class="sc">+</span> <span class="dv">1</span>]</span>
<span id="cb19-62"><a href="#cb19-62" aria-hidden="true" tabindex="-1"></a>    bond_growth <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb19-63"><a href="#cb19-63" aria-hidden="true" tabindex="-1"></a>    shortdebt_growth <span class="ot">&lt;-</span> allocation[<span class="st">"ShortDebt"</span>] <span class="sc">*</span> shortdebt_returns[i <span class="sc">%%</span> <span class="fu">length</span>(shortdebt_returns) <span class="sc">+</span> <span class="dv">1</span>]</span>
<span id="cb19-64"><a href="#cb19-64" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-65"><a href="#cb19-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Update account balance with growth</span></span>
<span id="cb19-66"><a href="#cb19-66" aria-hidden="true" tabindex="-1"></a>    account_balance <span class="ot">&lt;-</span> account_balance <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> us_growth <span class="sc">+</span> international_growth <span class="sc">+</span> bond_growth <span class="sc">+</span> shortdebt_growth)</span>
<span id="cb19-67"><a href="#cb19-67" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-68"><a href="#cb19-68" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Monthly withdrawal</span></span>
<span id="cb19-69"><a href="#cb19-69" aria-hidden="true" tabindex="-1"></a>    account_balance <span class="ot">&lt;-</span> account_balance <span class="sc">-</span> monthly_withdrawal</span>
<span id="cb19-70"><a href="#cb19-70" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-71"><a href="#cb19-71" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure account balance does not go negative (you can't withdraw more than available)</span></span>
<span id="cb19-72"><a href="#cb19-72" aria-hidden="true" tabindex="-1"></a>    account_balance <span class="ot">&lt;-</span> <span class="fu">max</span>(account_balance, <span class="dv">0</span>)</span>
<span id="cb19-73"><a href="#cb19-73" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb19-74"><a href="#cb19-74" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-75"><a href="#cb19-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(account_balance)</span>
<span id="cb19-76"><a href="#cb19-76" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-77"><a href="#cb19-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-78"><a href="#cb19-78" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to generate bootstrap simulations</span></span>
<span id="cb19-79"><a href="#cb19-79" aria-hidden="true" tabindex="-1"></a>generate_bootstrap_histories <span class="ot">&lt;-</span> <span class="cf">function</span>(n_simulations, data_sap500, data_msci, data_shortdebts) {</span>
<span id="cb19-80"><a href="#cb19-80" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-81"><a href="#cb19-81" aria-hidden="true" tabindex="-1"></a>  bootstrap_histories <span class="ot">&lt;-</span> <span class="fu">list</span>()  <span class="co"># To store the results of all simulations</span></span>
<span id="cb19-82"><a href="#cb19-82" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-83"><a href="#cb19-83" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Loop to generate multiple simulations (n_simulations)</span></span>
<span id="cb19-84"><a href="#cb19-84" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_simulations) {</span>
<span id="cb19-85"><a href="#cb19-85" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-86"><a href="#cb19-86" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Randomly sample parameters for each simulation</span></span>
<span id="cb19-87"><a href="#cb19-87" aria-hidden="true" tabindex="-1"></a>    age <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">25</span><span class="sc">:</span><span class="dv">75</span>, <span class="dv">1</span>)  <span class="co"># Random age between 25 and 75</span></span>
<span id="cb19-88"><a href="#cb19-88" aria-hidden="true" tabindex="-1"></a>    salary <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">30000</span><span class="sc">:</span><span class="dv">150000</span>, <span class="dv">1</span>)  <span class="co"># Random salary between $30,000 and $150,000</span></span>
<span id="cb19-89"><a href="#cb19-89" aria-hidden="true" tabindex="-1"></a>    start_date <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">seq.Date</span>(<span class="fu">as.Date</span>(<span class="st">"2000-01-01"</span>), <span class="fu">as.Date</span>(<span class="st">"2010-01-01"</span>), <span class="at">by =</span> <span class="st">"years"</span>), <span class="dv">1</span>)  <span class="co"># Random start date</span></span>
<span id="cb19-90"><a href="#cb19-90" aria-hidden="true" tabindex="-1"></a>    life_expectancy <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">75</span><span class="sc">:</span><span class="dv">100</span>, <span class="dv">1</span>)  <span class="co"># Random life expectancy</span></span>
<span id="cb19-91"><a href="#cb19-91" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-92"><a href="#cb19-92" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Call the ORP calculation function (second version)</span></span>
<span id="cb19-93"><a href="#cb19-93" aria-hidden="true" tabindex="-1"></a>    final_balance <span class="ot">&lt;-</span> <span class="fu">calculate_orp</span>(age, salary, start_date, data_sap500, data_msci, data_shortdebts, life_expectancy)</span>
<span id="cb19-94"><a href="#cb19-94" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-95"><a href="#cb19-95" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Store the result for this simulation</span></span>
<span id="cb19-96"><a href="#cb19-96" aria-hidden="true" tabindex="-1"></a>    bootstrap_histories[[i]] <span class="ot">&lt;-</span> final_balance</span>
<span id="cb19-97"><a href="#cb19-97" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb19-98"><a href="#cb19-98" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-99"><a href="#cb19-99" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Return the bootstrap histories</span></span>
<span id="cb19-100"><a href="#cb19-100" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(bootstrap_histories)</span>
<span id="cb19-101"><a href="#cb19-101" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-102"><a href="#cb19-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-103"><a href="#cb19-103" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of bootstrap simulations to run (e.g., 200)</span></span>
<span id="cb19-104"><a href="#cb19-104" aria-hidden="true" tabindex="-1"></a>n_simulations <span class="ot">&lt;-</span> <span class="dv">200</span></span>
<span id="cb19-105"><a href="#cb19-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-106"><a href="#cb19-106" aria-hidden="true" tabindex="-1"></a><span class="co"># Call the function to generate the bootstrap histories</span></span>
<span id="cb19-107"><a href="#cb19-107" aria-hidden="true" tabindex="-1"></a>bootstrap_histories <span class="ot">&lt;-</span> <span class="fu">generate_bootstrap_histories</span>(n_simulations, data_sap500, data_msci, data_shortdebts)</span>
<span id="cb19-108"><a href="#cb19-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-109"><a href="#cb19-109" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the bootstrap histories to a data frame</span></span>
<span id="cb19-110"><a href="#cb19-110" aria-hidden="true" tabindex="-1"></a>bootstrap_results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">final_balance =</span> <span class="fu">unlist</span>(bootstrap_histories))</span>
<span id="cb19-111"><a href="#cb19-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-112"><a href="#cb19-112" aria-hidden="true" tabindex="-1"></a><span class="co"># Printing some summary statistics of the total projected balances</span></span>
<span id="cb19-113"><a href="#cb19-113" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(bootstrap_results)</span>
<span id="cb19-114"><a href="#cb19-114" aria-hidden="true" tabindex="-1"></a><span class="do">##  final_balance    </span></span>
<span id="cb19-115"><a href="#cb19-115" aria-hidden="true" tabindex="-1"></a><span class="do">##  Min.   :  17765  </span></span>
<span id="cb19-116"><a href="#cb19-116" aria-hidden="true" tabindex="-1"></a><span class="do">##  1st Qu.: 260555  </span></span>
<span id="cb19-117"><a href="#cb19-117" aria-hidden="true" tabindex="-1"></a><span class="do">##  Median : 457571  </span></span>
<span id="cb19-118"><a href="#cb19-118" aria-hidden="true" tabindex="-1"></a><span class="do">##  Mean   : 598146  </span></span>
<span id="cb19-119"><a href="#cb19-119" aria-hidden="true" tabindex="-1"></a><span class="do">##  3rd Qu.: 811205  </span></span>
<span id="cb19-120"><a href="#cb19-120" aria-hidden="true" tabindex="-1"></a><span class="do">##  Max.   :2363385</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now, let’s visualize the results of our second simulation in a histogram with mean and median.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the mean and median of the final balances</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>mean_balance <span class="ot">&lt;-</span> <span class="fu">mean</span>(bootstrap_results<span class="sc">$</span>final_balance)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>median_balance <span class="ot">&lt;-</span> <span class="fu">median</span>(bootstrap_results<span class="sc">$</span>final_balance)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a histogram or density plot with mean and median lines</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(bootstrap_results, <span class="fu">aes</span>(<span class="at">x =</span> final_balance)) <span class="sc">+</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="dv">5000</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">fill =</span> <span class="st">"skyblue"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add vertical lines for mean and median</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept =</span> mean_balance), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept =</span> median_balance), <span class="at">color =</span> <span class="st">"green"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add labels for the mean and median lines</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> mean_balance <span class="sc">+</span> <span class="dv">20000</span>, <span class="at">y =</span> <span class="dv">10</span>, <span class="at">label =</span> <span class="fu">paste</span>(<span class="st">"Mean:"</span>, <span class="fu">round</span>(mean_balance, <span class="dv">2</span>)), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">hjust =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> median_balance <span class="sc">+</span> <span class="dv">20000</span>, <span class="at">y =</span> <span class="dv">10</span>, <span class="at">label =</span> <span class="fu">paste</span>(<span class="st">"Median:"</span>, <span class="fu">round</span>(median_balance, <span class="dv">2</span>)), <span class="at">color =</span> <span class="st">"green"</span>, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">hjust =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Distribution of ORP Final Account Balances (200 Simulations)"</span>,</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Final Account Balance ($)"</span>,</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Frequency"</span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>)</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="mp04_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>As we can see from our simulations, it would appear that the TRS plan nets a retiree, on average, about twice as much as the ORP plan. Although the ORP plan initially nets a retiree more money monthly than the TRS plan, it eventually falls behind the TRS plan as the total amount of funds in the ORP account decrease. Notably, it also appears that under the ORP plan, a retiree is more likely to run out of retirement funds earlier than under the TRS plan; which would make sense given that the TRS plan essentially guarantees income for life.</p>
</section>
<section id="recommendation" class="level2">
<h2 class="anchored" data-anchor-id="recommendation">RECOMMENDATION</h2>
<p><strong>For: A CUNY Employee at age 50, with a 10 year tenure and 10 years remaining working at CUNY, making 70000, 75000, and 80,000 dollars in the last 3 years respectfully.</strong></p>
<p>Based on your current age of 50 years old, your 10 year tenure with CUNY, and your remaining 10 years of service, we would recommend considering a transition to the Teachers’ Retirement System (TRS) plan for your retirement strategy. Here are some of the key factors driving this recommendation:</p>
<p><strong>Stronger Long-Term Retirement Income:</strong> Over the course of a typical retirement, the TRS plan nets a retiree, on average, about twice as much as the Optional Retirement Program (ORP) plan. Although the ORP plan may provide a higher monthly income initially, the TRS plan ultimately surpasses the ORP plan over time; especially as the funds in the ORP account decrease.</p>
<p><strong>Lower Risk of Outliving Retirement Savings:</strong> Retirees under the ORP plan are more likely to run out of retirement funds earlier than those enrolled in the TRS plan. The TRS plan offers a guaranteed lifetime income, reducing the risk of running out of funds as you age. This provides more security and peace of mind during your retirement years.</p>
<p><strong>Guaranteed Income for Life:</strong> Unlike the ORP plan, which is subject to market fluctuations and diminishing balances, the TRS plan offers a guaranteed stream of income for life, making it a more reliable option for those who are risk-averse and seeking stable retirement benefits.</p>
<p><strong>Lifespan and Risk Tolerance:</strong> Given that you are 50 years old and have approximately 10 years remaining in your career, you have enough time to benefit from the enhanced long-term growth potential of the TRS plan. If you are risk-averse, the security of the TRS plan is likely to align better with your goals for a stable and reliable retirement income.</p>
<p>Considering your age, remaining years of service, and the desire for a secure retirement, we believe the TRS plan offers the best long-term financial stability. While the ORP plan may provide higher initial monthly payments, its sustainability and the potential to deplete funds earlier make it less favorable as you age. The TRS plan provides you with guaranteed income for life, which is an important factor as you grow old and seek to enjoy your retirement.</p>
<p><strong>Disclaimer:</strong> <em>Past performance is not a guarantee of future results.</em></p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/slyastrologer\.github\.io\/STA9750-2024-FALL\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>